<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GreenBridge ‚Äî Calculateur consommation (export PDF)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --topbar-h:48px; --header-h:72px;
  --green-dark:#061f14; --green-mid:#073217; --green-mid-2:#0b4d26;
  --accent:#7cb342; --accent-2:#a8e6a1; --bg:#0a4d2e; --muted:#e6f7ea; --gold:#d4af37;
  --card-radius:12px; --font: 'Poppins', Arial, sans-serif;
  --bim-bg: #fff4d0; --bim-text: #b37400;
  --max-width:1100px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:var(--bg);color:#fff;scroll-behavior:smooth}
a{color:inherit;text-decoration:none}

/* Topbar & header */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:var(--green-dark);display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 4vw;z-index:1800;font-size:14px}
header{position:fixed;top:var(--topbar-h);left:0;right:0;height:var(--header-h);background:linear-gradient(90deg,var(--green-mid),var(--green-mid-2));display:flex;align-items:center;justify-content:space-between;padding:0 4vw;z-index:1750;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.logo-text{display:flex;align-items:center;gap:12px}
.logo-text img{height:56px;display:block}
.company-name{font-size:24px;font-weight:800;color:#04462e;-webkit-text-stroke:0.8px var(--gold);padding:6px 10px;border-radius:8px}

/* Nav */
nav{display:flex;gap:12px;align-items:center}
nav a{color:#fff;font-size:14px;font-weight:600;padding:8px 10px;border-radius:8px;transition:all .18s;display:flex;gap:8px;align-items:center;white-space:nowrap}
nav a:hover{color:var(--accent-2)}
nav a.active{color:var(--accent-2);background: linear-gradient(90deg, rgba(212,175,55,0.06), rgba(212,175,55,0.03));border:1px solid rgba(212,175,55,0.22);padding:10px 12px;font-weight:800;border-radius:10px}

/* Mobile menu button */
.menu-btn{display:none;background:transparent;border:0;color:#fff;font-size:20px;padding:8px;border-radius:8px}

/* page center wrapper */
.page-center{ max-width:var(--max-width); margin: calc(var(--topbar-h) + var(--header-h) + 18px) auto 80px; padding:0 18px; }

/* cards */
.card{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
#map{height:220px;border-radius:8px;overflow:hidden}

/* calc inner */
.calc{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;margin-top:12px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
.calc h3{margin:0;color:#04462e;font-size:16px}
.small-note{font-size:12px;color:#6b7f6b;margin-top:8px}

/* top controls */
.top-controls{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
.top-controls label{white-space:nowrap;font-size:13px;color:#072012}
.top-controls select, .top-controls input{padding:8px;border-radius:6px;min-width:120px;max-width:360px;border:1px solid #e6e6e6}
.btn-reset{margin-left:auto;padding:8px 10px;border-radius:8px;border:0;background:#e7e7e7;color:#072012;cursor:pointer;font-weight:600}
.btn-export{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#072012;font-weight:700;cursor:pointer}

/* Generator area */
.generator{display:flex;gap:8px;align-items:center;margin:12px 0;padding:10px;border-radius:8px;background:linear-gradient(180deg,#f7fff6,#f0fff1);border:1px solid #e6f7ea}
.generator .col{display:flex;flex-direction:column;gap:6px;color:#072012}
.generator input[type="number"]{width:70px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
.generator .actions{margin-left:auto;display:flex;gap:8px;align-items:center}

/* SUBTITLES (par pi√®ce) */
.subtitles{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.subtitle{background:linear-gradient(180deg,#f3fff8,#ecfff5);color:#072012;padding:10px;border-radius:10px;border:1px solid #e0f3e9;display:flex;align-items:center;gap:12px;min-width:220px;cursor:pointer}
.subtitle .left{flex:1}
.subtitle .title{font-weight:800;color:#04462e;font-size:15px}
.subtitle .meta{font-size:13px;color:#6b7f6b;margin-top:4px}
.subtitle .right{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
.subtitle .small-variant{font-size:12px;color:#666}

/* rooms panel */
.rooms-panel{margin-top:12px;background:#fff;padding:12px;border-radius:12px;color:#072012}
.room{background:#f7f7f7;padding:10px;border-radius:8px;border:1px solid #ececec;margin-top:8px}
.room .room-head{display:flex;justify-content:space-between;align-items:center}
.room .room-actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.consumer-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.consumer{display:flex;gap:8px;align-items:center;padding:8px;background:#fff;border-radius:6px;border:1px solid #eee;flex-wrap:wrap}

/* results */
.results{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.result-card{background:rgba(0,0,0,0.03);padding:12px;border-radius:8px;flex:1;text-align:center;min-width:170px}
.result-card .label{font-size:13px;color:#6b7f6b}
.result-card .value{font-weight:800;font-size:18px;color:#04462e;margin-top:6px}
.result-card .small{font-size:12px;color:#6b7f6b;margin-top:6px}
.result-card#bimCard{ background: var(--bim-bg); border:2px solid rgba(179,116,0,0.14); box-shadow:0 6px 18px rgba(179,116,0,0.08); }
.result-card#bimCard .value{ color: var(--bim-text); font-size:20px }

/* responsive improvements for small screens */
@media (max-width:900px){
  :root{ --max-width:900px; }
  .company-name{font-size:20px}
  .page-center{ padding:0 14px; margin-top: calc(var(--topbar-h) + var(--header-h) + 12px); }
  #map{height:180px}
  .top-controls select, .top-controls input{min-width:100px; font-size:14px}
  .generator{flex-direction:column;align-items:stretch}
  .nav-hidden{display:none}
  .menu-btn{display:inline-block}
  nav{display:none; position:absolute; left:12px; top:calc(var(--topbar-h) + var(--header-h)); background:linear-gradient(180deg,var(--green-mid),var(--green-mid-2)); padding:12px; border-radius:8px; z-index:2000}
  nav a{display:block;margin:6px 0}
  .btn-export{width:100%}
  .btn-reset{width:100%}
  .room .room-actions{flex-direction:column;align-items:stretch}
  .consumer{font-size:14px}
}

/* very small screens */
@media (max-width:420px){
  .company-name{font-size:18px}
  .topbar, header{padding:0 10px}
  .logo-text img{height:48px}
  .small-note{font-size:12px}
  .subtitle{min-width:160px;padding:8px}
}

/* PDF note */
.pdf-note{font-size:12px;color:#6b7f6b;margin-top:8px}

/* highlight animation */
.room.highlight{box-shadow:0 0 0 3px rgba(124,179,66,0.18);transition:box-shadow .6s}
</style>
</head>
<body>

<!-- topbar/header -->
<div class="topbar">
  <div class="left"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Abidjan, C√¥te d‚ÄôIvoire</div>
  <div class="right"><i class="fas fa-phone" aria-hidden="true"></i> +225 07 07 07 07 07</div>
</div>

<header>
  <div style="display:flex;align-items:center;gap:12px">
    <button class="menu-btn" id="menuBtn" aria-label="Afficher le menu"><i class="fas fa-bars"></i></button>
    <div class="logo-text">
      <a href="#"><img src="green bridge domo.png" alt="logo"></a>
      <div class="company-name">GREENBRIDGE</div>
    </div>
  </div>

  <nav aria-label="Menu principal" id="mainNav">
    <a href="#" class="active">Accueil</a>
    <a href="#">√ânergie</a>
    <a href="#">Domotique</a>
    <a href="#">S√©curit√©</a>
    <a href="#">Maintenance</a>
  </nav>
</header>

<!-- CENTERED PAGE WRAPPER -->
<div class="page-center" role="main" aria-label="Calculateur principal">

  <!-- header for form -->
  <div class="card" style="margin-bottom:12px; text-align:left;">
    <h2 style="margin:6px 0;color:#04462e">Renseignez vos consommateurs</h2>
    <p style="margin:0;color:#3d5b3f">Indique la quantit√©, la fr√©quence d'utilisation et la taille/marque lorsque demand√©. G√©n√®re des pi√®ces et pr√©-remplit les consommateurs par pi√®ce.</p>
  </div>

  <div class="card" id="mapCard" style="margin-bottom:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="color:#072012">Nos zones d'intervention</strong>
      <small style="color:#666">Abidjan ‚Ä¢ Yamoussoukro ‚Ä¢ Dakar</small>
    </div>
    <div id="map" style="margin-top:10px"></div>

    <!-- Calculator directly under map -->
    <div class="calc" id="calcCard">
      <h3>Calculateur rapide ‚Äî Consommation</h3>
      <div class="small-note">Saisissez uniquement les quantit√©s et la fr√©quence (taille/marque quand demand√©). Hypoth√®ses internes ‚Äî r√©sultats indicatifs.</div>

      <!-- controls -->
      <div class="top-controls" style="margin-top:10px;">
        <label style="font-size:13px;color:#072012">Zone :</label>
        <select id="zone" aria-label="Zone">
          <option value="ci">C√¥te d'Ivoire</option>
          <option value="sn">S√©n√©gal</option>
        </select>

        <label style="font-size:13px;color:#072012">Ville :</label>
        <select id="city" aria-label="Ville"></select>

        <label style="font-size:13px;color:#072012">Type tarifaire :</label>
        <select id="tarif" style="min-width:200px" aria-label="Type tarifaire"></select>

        <button id="resetBtn" class="btn-reset" title="R√©initialiser toutes les valeurs">R√©initialiser</button>
        <button id="exportPdfBtn" class="btn-export" title="Exporter la synth√®se en PDF">Exporter (PDF)</button>
      </div>

      <!-- GENERATOR (pr√©r√©mplissage pi√®ces) -->
      <div class="generator" role="group" aria-label="G√©n√©rateur rapide de pi√®ces" style="margin-top:12px">
        <div class="col">
          <label style="font-size:13px;color:#072012">Chambres</label>
          <input type="number" id="genBedrooms" min="0" value="1">
        </div>
        <div class="col">
          <label style="font-size:13px;color:#072012">Salons</label>
          <input type="number" id="genLiving" min="0" value="1">
        </div>
        <div class="col">
          <label style="font-size:13px;color:#072012">Cuisines</label>
          <input type="number" id="genKitchens" min="0" value="1">
        </div>
        <div class="col">
          <label style="font-size:13px;color:#072012">Salles d'eau</label>
          <input type="number" id="genBaths" min="0" value="1">
        </div>
        <div class="col">
          <label style="font-size:13px;color:#072012">Bureaux</label>
          <input type="number" id="genOffices" min="0" value="0">
        </div>
        <div class="col">
          <label style="font-size:13px;color:#072012">Toilettes</label>
          <input type="number" id="genToilets" min="0" value="0">
        </div>

        <div class="actions">
          <label style="font-size:13px;color:#072012;display:flex;align-items:center;gap:6px"><input type="checkbox" id="genAdd" /> Ajouter</label>
          <button id="generateBtn" class="btn-export">G√©n√©rer pi√®ces</button>
        </div>
      </div>

      <!-- SUBTITLES: r√©sum√© par pi√®ce (cliquables) -->
      <div id="itemsSubtitles" class="subtitles" aria-live="polite" aria-atomic="true" style="margin-bottom:8px"></div>

      <!-- rooms panel (d√©tails modifiables) -->
      <div id="roomsPanel" class="rooms-panel" style="display:block; margin-top:12px;">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <label style="font-weight:700">Ajouter une pi√®ce manuelle :</label>
          <select id="roomTypeSelect">
            <option value="Chambre">Chambre</option>
            <option value="Salon">Salon</option>
            <option value="Cuisine">Cuisine</option>
            <option value="Salle d'eau">Salle d'eau</option>
            <option value="Bureau">Bureau</option>
            <option value="Toilette">Toilette</option>
            <option value="Autre">Autre</option>
          </select>
          <input id="roomNameInput" placeholder="Ex: Chambre parentale" style="padding:8px;border-radius:6px;border:1px solid #ddd">
          <label>Quantit√© :</label>
          <input id="roomCountInput" type="number" min="1" value="1" style="width:90px;padding:8px;border-radius:6px;border:1px solid #ddd">
          <div style="margin-left:auto;display:flex;gap:8px">
            <button id="addRoomsBtn" class="btn-export">Ajouter pi√®ce(s)</button>
            <button id="clearRoomsBtn" class="btn-reset">Vider pi√®ces</button>
          </div>
        </div>

        <div id="roomsList" class="room-list" style="margin-top:12px"></div>
        <div class="small-note" style="margin-top:8px">Apr√®s cr√©ation : clique sur un sous-titre pour aller √† la pi√®ce correspondante et modifier ses consommateurs.</div>
      </div>

      <!-- autres -->
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="enableAutres"><label for="enableAutres" style="color:#072012">Saisir "Autres (Grande puissance)"</label>
      </div>
      <div id="autresPanel" style="display:none;margin-top:8px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#072012">Qt√©</label><input id="autresQty" class="qty" type="number" value="0" min="0" style="width:70px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <label style="font-size:13px;color:#072012">Puissance (W)</label><input id="autresPower" class="qty" type="number" value="0" style="width:100px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <label style="font-size:13px;color:#072012">Heures/j</label><input id="autresH" class="qty" type="number" value="0" step="0.1" style="width:90px;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
        </div>
      </div>

      <!-- results -->
      <div class="results">
        <div class="result-card">
          <div class="label">Consommation (kWh / mois)</div>
          <div id="consMonth" class="value">0 kWh</div>
          <div id="consMonthRange" class="small">plage: 0 - 0 kWh</div>
        </div>
        <div class="result-card">
          <div class="label">Montant (mensuel)</div>
          <div id="montantMens" class="value">0 FCFA</div>
          <div id="montantMensRange" class="small">plage: 0 - 0 FCFA</div>
        </div>
        <div class="result-card" id="bimCard">
          <div class="label">Montant (bimensiel)</div>
          <div id="montantBi" class="value">0 FCFA</div>
          <div id="montantBiRange" class="small">plage: 0 - 0 FCFA</div>
        </div>
        <div class="result-card">
          <div class="label">Montant (hebdo)</div>
          <div id="montantHebdo" class="value">0 FCFA</div>
          <div id="montantHebdoRange" class="small">plage: 0 - 0 FCFA</div>
        </div>
      </div>

      <div class="pdf-note">PDF : synth√®se exportable avec filigrane GREENBRIDGE et la mention ¬´ √Ä TITRE INDICATIF ¬ª.</div>
    </div>
  </div>

</div> <!-- /.page-center -->

<footer class="footer" style="text-align:center;color:#fff;padding:28px 5vw 36px;">
  <div class="brand">GREENBRIDGE</div>
  <div class="small">¬© 2025 GreenBridge √ânergie ‚Äî Abidjan, C√¥te d‚ÄôIvoire ‚Äî Tel: +225 07 07 07 07 07.</div>
</footer>

<!-- libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ==============================
   Catalogue enrichi + duty cycles (avec Plasma)
   ============================== */
const catalogue = [
  { id:'eclairage', label:'√âclairage ‚Ä¢ LED/Fluo', icon:'fa-lightbulb', color:'#ffd54f', variantType:'none', powerW:20, hours:4 },
  { id:'ventilation', label:'Ventilation', icon:'fa-fan', color:'#90caf9', variantType:'size', sizes:{'Petit':{min:25,max:50},'Moyen':{min:50,max:75},'Grand':{min:75,max:100}}, defaultSize:'Moyen', hours:8 },
  { id:'vent_plafond', label:'Ventilateur Plafond', icon:'fa-fan', color:'#80deea', variantType:'size', sizes:{'Plafond':{min:120,max:120}}, defaultSize:'Plafond', hours:3 },
  { id:'clim', label:'Climatisation ‚Ä¢ Climatiseur', icon:'fa-snowflake', color:'#b39ddb', variantType:'size',
    sizes:{ 'Petit':{min:400,max:900}, 'Moyen':{min:900,max:1500}, 'Grand':{min:1500,max:3500} }, defaultSize:'Moyen', cycling:true },
  { id:'phone', label:'T√©l√©phone portable', icon:'fa-mobile-screen', color:'#a5d6a7', variantType:'none', powerW:10, hours:2 },
  { id:'tablet', label:'Tablette', icon:'fa-tablet-screen-button', color:'#c5e1a5', variantType:'none', powerW:20, hours:1 },
  { id:'pcp', label:'PC portable', icon:'fa-laptop', color:'#ffe082', variantType:'none', powerW:85, hours:4 },
  { id:'pcb', label:'PC Bureau', icon:'fa-desktop', color:'#ffd3b6', variantType:'none', powerW:170, hours:4 },
  // TV LED variant
  { id:'tv', label:'TV ‚Ä¢ √âcran LED', icon:'fa-tv', color:'#ffab91', variantType:'size',
    sizes:{'LED Petite':{min:20,max:60},'LED Moyenne':{min:60,max:150}}, defaultSize:'LED Moyenne', hours:4 },
  // TV Plasma (nouvelle entr√©e)
  { id:'tv_plasma', label:'TV ‚Ä¢ √âcran Plasma', icon:'fa-tv', color:'#ff8a65', variantType:'size',
    sizes:{ 'Standard': { min:180, max:250 } }, defaultSize:'Standard', hours:4 },
  { id:'decodeur', label:'D√©codeur DSL/ADSL', icon:'fa-wifi', color:'#ce93d8', variantType:'none', powerW:10, hours:24 },
  { id:'frigo', label:'R√©frig√©rateur', icon:'fa-box-archive', color:'#a7ffeb', variantType:'size',
    sizes:{ 'Petit':{min:50,max:120}, 'Moyen':{min:100,max:180}, 'Grand':{min:150,max:250} }, defaultSize:'Moyen', cycling:true },
  { id:'congel', label:'Cong√©lateur', icon:'fa-snowflake', color:'#b2ebf2', variantType:'size',
    sizes:{ 'Petit':{min:80,max:150}, 'Moyen':{min:120,max:200}, 'Grand':{min:200,max:300} }, defaultSize:'Moyen', cycling:true },
  { id:'seche', label:'S√®che Cheveux', icon:'fa-wind', color:'#ffcc80', variantType:'none', powerW:2000, hours:0.05 },
  { id:'micro', label:'Micro-Onde', icon:'fa-burn', color:'#ffd180', variantType:'none', powerW:900, hours:0.05 },
  { id:'cafe', label:'Cafeti√®re / Bouilloire', icon:'fa-mug-hot', color:'#ffecb3', variantType:'none', powerW:1500, hours:0.05 },
  { id:'robot', label:'Robot / Mixeur', icon:'fa-blender', color:'#c8e6c9', variantType:'none', powerW:500, hours:0.05 }
];

// Duty cycles par √©quipement / taille (facteur de marche)
const DEFAULT_DUTY_CYCLES = {
  'clim': { 'Petit':0.35, 'Moyen':0.50, 'Grand':0.70 },
  'frigo': { 'Petit':0.25, 'Moyen':0.40, 'Grand':0.50 },
  'congel': { 'Petit':0.30, 'Moyen':0.40, 'Grand':0.55 }
};

/* ------------------------------
   √©tat (items, pi√®ces)
   ------------------------------ */
let items = catalogue.map(c => ({
  ...c,
  qty:0, usage:'Tous les jours',
  selectedSize: c.defaultSize || (c.sizes ? Object.keys(c.sizes)[0] : undefined),
  selectedBrand: c.defaultBrand || (c.brands ? Object.keys(c.brands)[0] : undefined)
}));

let pieces = [];

// Facteurs conformes √† ton tableau
const usageFactors = {'Tous les jours':1,'R√©gulier':0.75,'Occasionnel':0.5,'Rare':0.25};

/* ---------- DOM refs ---------- */
const tarifSelect = document.getElementById('tarif');
const zoneSelect = document.getElementById('zone');
const citySelect = document.getElementById('city');
const consMonthEl = document.getElementById('consMonth');
const consMonthRangeEl = document.getElementById('consMonthRange');
const montantMensEl = document.getElementById('montantMens');
const montantMensRangeEl = document.getElementById('montantMensRange');
const montantBiEl = document.getElementById('montantBi');
const montantBiRangeEl = document.getElementById('montantBiRange');
const montantHebdoEl = document.getElementById('montantHebdo');
const montantHebdoRangeEl = document.getElementById('montantHebdoRange');

const enableAutres = document.getElementById('enableAutres');
const autresPanel = document.getElementById('autresPanel');
const autresQty = document.getElementById('autresQty');
const autresPower = document.getElementById('autresPower');
const autresH = document.getElementById('autresH');
const resetBtn = document.getElementById('resetBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const menuBtn = document.getElementById('menuBtn');

const genBedrooms = document.getElementById('genBedrooms');
const genLiving = document.getElementById('genLiving');
const genKitchens = document.getElementById('genKitchens');
const genBaths = document.getElementById('genBaths');
const genOffices = document.getElementById('genOffices');
const genToilets = document.getElementById('genToilets');
const genAdd = document.getElementById('genAdd');
const generateBtn = document.getElementById('generateBtn');

const roomTypeSelect = document.getElementById('roomTypeSelect');
const roomNameInput = document.getElementById('roomNameInput');
const roomCountInput = document.getElementById('roomCountInput');
const addRoomsBtn = document.getElementById('addRoomsBtn');
const clearRoomsBtn = document.getElementById('clearRoomsBtn');
const roomsListEl = document.getElementById('roomsList');
const itemsSubtitles = document.getElementById('itemsSubtitles');
const mainNav = document.getElementById('mainNav');

/* ------------------------------
   Map & villes/tarifs (identique)
   ------------------------------ */
let map = null;
const CITY_COORDS = {
  'ci_all': { bounds: [[5.345317,-4.024429],[6.818351,-5.276987]] , center:[6.05,-4.65], zoom:7 },
  'ci_abidjan': {lat:5.345317, lng:-4.024429, zoom:12 },
  'ci_yamoussoukro': {lat:6.818351, lng:-5.276987, zoom:11 },
  'sn_all': { center:[14.0,-14.0], zoom:6 },
  'sn_dakar': {lat:14.6937, lng:-17.44406, zoom:12 }
};
function initMap(){
  try {
    map = L.map('map', { dragging:true, zoomControl:true, attributionControl:false }).setView([6.5, -5.0], 6.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
    const pin = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[22,22], iconAnchor:[11,22] });
    L.marker([5.345317,-4.024429],{icon:pin}).addTo(map).bindTooltip('Abidjan');
    L.marker([6.818351,-5.276987],{icon:pin}).addTo(map).bindTooltip('Yamoussoukro');
    L.marker([14.6937,-17.44406],{icon:pin}).addTo(map).bindTooltip('Dakar');
    map.fitBounds([[5.345317,-4.024429],[6.818351,-5.276987]], { padding:[20,20] });
  } catch(e){ console.warn(e) }
}
function zoomToCity(key){
  if(!map) return;
  const info = CITY_COORDS[key];
  if(!info) return;
  if(info.bounds){ map.fitBounds(info.bounds, {padding:[20,20]}); }
  else if(info.lat && info.lng){ map.setView([info.lat, info.lng], info.zoom || 10); }
  else if(info.center){ map.setView(info.center, info.zoom || 7); }
}

/* ---------- Tariffs (CI & SN simplified) ---------- */
const CI_TARIFFS = {
  'social_5A': { label: "Tarif Domestique Social ‚Äî monophas√© 5A (post-paiement)", prime_bi: 614.90, tranche_limit_kwh_bi: 80, price_ht: [31.72, 55.18], redevance_rurale_per_kwh: 1.00, taxe_ordures_per_kwh_abj: 2.50, taxe_ordures_per_kwh_other: 1.00, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.00 },
  'dom_gen_5A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 5A (post-paiement)", prime_bi: 1371.22, price_ht: [73.66, 63.84], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'dom_gen_10A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 10A (post-paiement)", prime_bi: 1371.22, price_ht: [73.66, 63.84], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'dom_gen_15A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 15A (post-paiement)", prime_bi: 1508.34, price_ht: [81.03, 70.22], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'triphase': { label: "Tarif Domestique G√©n√©ral ‚Äî triphas√© (post-paiement)", prime_bi: 1508.34, price_ht: [81.03, 70.22], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 }
};
const SN_TARIFFS = {
  'SN_UD_DPP': { label:'Usage Domestique ‚Äî Petite Puissance (DPP)', prices:[91.17,136.49,159.36], tr:[150,200], prime_mois:0 },
  'SN_UD_DMP': { label:'Usage Domestique ‚Äî Moyenne Puissance (DMP)', prices:[111.23,143.54,158.46], tr:[50,300], prime_mois:0 },
  'SN_PREPAY_DPP': { label:'Pr√©pay√© ‚Äî Domestique Petite Puissance (DPP)', prices:[91.17,136.49,149.06], tr:[150,200], prime_mois:0 },
  'SN_UP_PPP': { label:'Usage Professionnel ‚Äî Petite Puissance (PPP)', prices:[163.81,189.84,198.68], tr:[50,500], prime_mois:0 }
};

/* ---------- Helpers ---------- */
function fmt(n,dec=2){ return Number(n||0).toFixed(dec).replace(/\B(?=(\d{3})+(?!\d))/g,' '); }
function fcfa(n){ return Number(Math.round(n||0)).toLocaleString('fr-FR') + ' FCFA' }
function fcfaRange(min,max){ return fcfa(min) + ' ‚Äî ' + fcfa(max); }

/* ---------- Billing functions (unchanged) ---------- */
function computeCIBill(consumption_kwh_bi, tariffKey, opts = {}) {
  const t = CI_TARIFFS[tariffKey];
  if(!t) return { total_bi:0, total_mois:0, total_hebdo:0 };
  let limit = t.tranche_limit_kwh_bi || 180 * (opts.puissanceSouscrite_kW || 1);
  let rem = consumption_kwh_bi, energy_ht_bi = 0;
  if(Array.isArray(t.price_ht) && limit !== undefined){
    const p1 = t.price_ht[0], p2 = t.price_ht[1];
    const inT1 = Math.min(rem, limit); energy_ht_bi += inT1 * p1; rem -= inT1;
    if(rem>0) energy_ht_bi += rem * p2;
  } else {
    energy_ht_bi = consumption_kwh_bi * (t.price_ht || 95);
  }
  const TVA = (typeof t.TVA==='number')?t.TVA:0.18;
  const tva = energy_ht_bi * TVA;
  const prime = Number(t.prime_bi||0);
  const other = (t.redevance_rurale_per_kwh||0)*consumption_kwh_bi + (opts.isAbidjan? (t.taxe_ordures_per_kwh_abj||0) : (t.taxe_ordures_per_kwh_other||0))*consumption_kwh_bi + (t.redevance_electrif_bi||0);
  const rti = Math.min((t.redevance_rti_per_kwh||0)*consumption_kwh_bi, t.rti_cap_bi || 999999);
  const total_bi = energy_ht_bi + tva + prime + other + rti;
  return { total_bi, total_mois: total_bi/2, total_hebdo: (total_bi/2)/4, energy_ht_bi, tva_bi:tva, prime_bi:prime, other_taxes: other + rti };
}
function computeSNBill(consumption_kwh_month, tariffKey){
  const t = SN_TARIFFS[tariffKey];
  if(!t) return { total_mois:0, total_bi:0, total_hebdo:0 };
  let rem = consumption_kwh_month, energy_ht = 0;
  const tr = t.tr || t.tranches || t.tr;
  if(Array.isArray(t.prices) && Array.isArray(tr) && tr.length>=2){
    const p1=t.prices[0], p2=t.prices[1], p3=t.prices[2];
    const inT1 = Math.min(rem, tr[0]); energy_ht += inT1*p1; rem-=inT1;
    if(rem>0){ const inT2 = Math.min(rem, (tr[1]-(tr[0]||0))); energy_ht += inT2*p2; rem-=inT2; }
    if(rem>0) energy_ht += rem*p3;
  } else energy_ht = consumption_kwh_month * (t.prices? t.prices[0] : 150);
  const total_mois = energy_ht + (t.prime_mois||0);
  return { total_mois, total_bi: total_mois*2, total_hebdo: total_mois/4, energy_ht_month: energy_ht };
}

/* ------------------------------
   Pr√©fill rules (par type de pi√®ce) - Salon pr√©-remplit avec TV Plasma
   ------------------------------ */
const DEFAULT_PREFILL = {
  'Chambre': [
    { id:'eclairage', qty:1 },
    { id:'phone', qty:1 }
  ],
  'Salon': [
    { id:'eclairage', qty:1 },
    { id:'tv_plasma', qty:1 },
    { id:'decodeur', qty:1 }
  ],
  'Cuisine': [
    { id:'eclairage', qty:1 },
    { id:'frigo', qty:1 },
    { id:'micro', qty:1 }
  ],
  "Salle d'eau": [
    { id:'eclairage', qty:1 },
    { id:'ventilation', qty:1 }
  ],
  'Bureau': [
    { id:'eclairage', qty:1 },
    { id:'pcp', qty:1 }
  ],
  'Toilette': [
    { id:'eclairage', qty:1 }
  ]
};

/* ------------------------------
   Subtitles rendering
   ------------------------------ */
function summarizePieceConsumers(consumers){
  const map = {};
  consumers.forEach(c=>{
    map[c.id] = (map[c.id]||0) + (Number(c.qty)||0);
  });
  const parts = Object.keys(map).slice(0,6).map(k=>{
    const cat = catalogue.find(x=>x.id===k);
    const label = cat?cat.label.split(' ‚Ä¢ ')[0]:k;
    return `${label}: ${map[k]}`;
  });
  return parts.join(' ¬∑ ');
}

function renderSubtitlesFromPieces(){
  itemsSubtitles.innerHTML = '';
  if(!pieces.length){ itemsSubtitles.style.display='none'; return; }
  itemsSubtitles.style.display='flex';
  pieces.forEach((p, idx)=>{
    const totalConsumers = p.consumers.reduce((s,c)=>s + (Number(c.qty)||0), 0);
    const subtitle = document.createElement('div');
    subtitle.className = 'subtitle';
    subtitle.dataset.idx = idx;
    subtitle.innerHTML = `
      <div class="left">
        <div class="title">${p.id}</div>
        <div class="meta">nombres de consommateurs : <strong>${totalConsumers}</strong> ‚Äî type : <strong>${p.type}</strong></div>
      </div>
      <div class="right">
        <div class="small-variant">${summarizePieceConsumers(p.consumers)}</div>
        <div style="font-weight:800">${p.consumers.length} √©quipements</div>
      </div>
    `;
    subtitle.addEventListener('click', ()=> {
      const el = document.getElementById('room-block-'+idx);
      if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'), 900); }
    });
    itemsSubtitles.appendChild(subtitle);
  });
}

/* ------------------------------
   Pieces UI functions
   ------------------------------ */
function addPieces(type, baseName, count, withPrefill=true){
  const c = Math.max(1, Number(count||1));
  for(let i=1;i<=c;i++){
    let name = (c===1) ? (baseName||type) : (baseName ? (baseName + ' ' + i) : (type + ' ' + i));
    let unique = name; let k=1;
    while(pieces.some(p=>p.id===unique)){ k++; unique = name + ' ('+k+')'; }
    const newPiece = { id: unique, type: type, consumers: [] };
    if(withPrefill){
      const rules = DEFAULT_PREFILL[type] || [];
      rules.forEach(r=>{
        const cat = catalogue.find(x=>x.id===r.id);
        if(!cat) return;
        newPiece.consumers.push({
          id: cat.id,
          label: cat.label,
          qty: r.qty,
          usage: 'Tous les jours',
          variantType: cat.variantType,
          selectedSize: cat.defaultSize || (cat.sizes? Object.keys(cat.sizes)[0] : undefined),
          selectedBrand: cat.defaultBrand || (cat.brands? Object.keys(cat.brands)[0] : undefined),
          variantLabel: (cat.variantType === 'size' ? (cat.defaultSize || '') : (cat.variantType === 'brand' ? (cat.defaultBrand || '') : '')),
          powerW: cat.powerW || 0,
          hours: cat.hours || 0,
          dutyCycle: (cat.cycling ? (DEFAULT_DUTY_CYCLES[cat.id] ? DEFAULT_DUTY_CYCLES[cat.id][cat.defaultSize || Object.keys(cat.sizes)[0]] : undefined) : undefined)
        });
      });
    }
    pieces.push(newPiece);
  }
  renderPieces();
  renderSubtitlesFromPieces();
  recalc();
}

function clearPieces(){
  if(!confirm('Vider toutes les pi√®ces et consommateurs ?')) return;
  pieces = [];
  renderPieces();
  renderSubtitlesFromPieces();
  recalc();
}

function renderPieces(){
  roomsListEl.innerHTML = '';
  if(pieces.length === 0) return;

  pieces.forEach((p, pIdx) => {
    const box = document.createElement('div');
    box.className = 'room';
    box.id = 'room-block-'+pIdx;

    // consumer entries
    const consumersHtml = p.consumers.map((c,ci)=>{
      const variant = c.variantLabel ? (' ‚Äî ' + c.variantLabel) : '';
      const dutyText = (c.dutyCycle && c.dutyCycle > 0) ? (` ‚Äî duty ${Math.round(c.dutyCycle*100)}%`) : '';
      return `<div class="consumer" data-p="${pIdx}" data-c="${ci}">
        <div style="flex:1"><strong>${c.label}</strong><div style="font-size:12px;color:#666;margin-top:6px">${variant}${dutyText}</div></div>
        <div style="display:flex;gap:6px;align-items:center">
          <div>Qt√©:<br/><input class="cons-qty" type="number" min="0" value="${c.qty}" style="width:70px;padding:6px;border-radius:6px;border:1px solid #ddd"></div>
          <div style="margin-left:6px">Fr√©q:<br/><select class="cons-usage"><option ${c.usage==='Tous les jours'?'selected':''}>Tous les jours</option><option ${c.usage==='R√©gulier'?'selected':''}>R√©gulier</option><option ${c.usage==='Occasionnel'?'selected':''}>Occasionnel</option><option ${c.usage==='Rare'?'selected':''}>Rare</option></select></div>
          <div style="margin-left:8px"><button class="btn-reset remove-consumer">Suppr</button></div>
        </div>
      </div>`;
    }).join('');

    box.innerHTML = `
      <div class="room-head">
        <div style="font-weight:800">${p.id} <span style="font-weight:600;color:#6b7f6b">(${p.type})</span></div>
        <div style="display:flex;gap:8px">
          <button data-idx="${pIdx}" class="btn-reset remove-piece">Suppr pi√®ce</button>
        </div>
      </div>

      <div class="room-actions">
        <select data-idx="${pIdx}" class="select-equip">${catalogue.map(c=>`<option value="${c.id}">${c.label}</option>`).join('')}</select>
        <select data-idx="${pIdx}" class="select-variant" style="display:none;padding:8px;border-radius:6px;border:1px solid #ddd"></select>
        <input data-idx="${pIdx}" class="input-qty" type="number" min="1" value="1" style="width:80px;padding:8px;border-radius:6px;border:1px solid #ddd">
        <select data-idx="${pIdx}" class="select-usage" style="padding:8px;border-radius:6px;border:1px solid #ddd">
          <option>Tous les jours</option><option>R√©gulier</option><option>Occasionnel</option><option>Rare</option>
        </select>
        <button data-idx="${pIdx}" class="btn-export add-to-piece">Ajouter au pi√®ce</button>
      </div>

      <div class="consumer-list" id="consumers-${pIdx}">
        ${consumersHtml || '<div style="font-size:13px;color:#666">Aucun consommateur ajout√©</div>'}
      </div>
    `;
    roomsListEl.appendChild(box);
  });

  // wire
  document.querySelectorAll('.select-equip').forEach(sel=>{
    sel.addEventListener('change', e=>{
      const pIdx = +e.target.dataset.idx;
      const selVar = document.querySelector('.select-variant[data-idx="'+pIdx+'"]');
      const cat = catalogue.find(c=>c.id === e.target.value);
      if(!cat) { selVar.style.display='none'; selVar.innerHTML=''; return; }
      if(cat.variantType === 'size'){
        selVar.style.display='inline-block';
        selVar.innerHTML = Object.keys(cat.sizes).map(sz=>`<option value="${sz}">${sz}</option>`).join('');
      } else if(cat.variantType === 'brand'){
        selVar.style.display='inline-block';
        selVar.innerHTML = Object.keys(cat.brands).map(b=>`<option value="${b}">${b}</option>`).join('');
      } else {
        selVar.style.display='none';
        selVar.innerHTML='';
      }
    });
    sel.dispatchEvent(new Event('change'));
  });

  document.querySelectorAll('.add-to-piece').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const pIdx = +e.target.dataset.idx;
      const selEquip = document.querySelector('.select-equip[data-idx="'+pIdx+'"]');
      const selVariant = document.querySelector('.select-variant[data-idx="'+pIdx+'"]');
      const qtyEl = document.querySelector('.input-qty[data-idx="'+pIdx+'"]');
      const usageEl = document.querySelector('.select-usage[data-idx="'+pIdx+'"]');
      const cat = catalogue.find(c=>c.id === selEquip.value);
      if(!cat) return;
      const qty = Math.max(0, Number(qtyEl.value||0));
      const usage = usageEl.value || 'Tous les jours';

      const cons = {
        id: cat.id,
        label: cat.label,
        qty: qty,
        usage: usage,
        variantType: cat.variantType,
        selectedSize: cat.defaultSize || (cat.sizes? Object.keys(cat.sizes)[0] : undefined),
        selectedBrand: cat.defaultBrand || (cat.brands? Object.keys(cat.brands)[0] : undefined),
        variantLabel: '',
        powerW: cat.powerW || 0,
        hours: cat.hours || 0
      };

      if(selVariant && selVariant.style.display !== 'none'){
        const val = selVariant.value;
        if(cat.variantType === 'size') { cons.selectedSize = val; cons.variantLabel = val; }
        if(cat.variantType === 'brand') { cons.selectedBrand = val; cons.variantLabel = val; }
      }

      // assign default dutyCycle if cycling equipment
      if(cat && cat.cycling){
        const map = DEFAULT_DUTY_CYCLES[cat.id] || {};
        cons.dutyCycle = map[cons.selectedSize] || map[Object.keys(map)[0]] || 0.4;
      }

      pieces[pIdx].consumers.push(cons);
      renderPieces();
      renderSubtitlesFromPieces();
      recalc();
    });
  });

  document.querySelectorAll('.remove-piece').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const pIdx = +e.target.dataset.idx;
      if(!confirm('Supprimer la pi√®ce "'+pieces[pIdx].id+'"?')) return;
      pieces.splice(pIdx,1);
      renderPieces();
      renderSubtitlesFromPieces();
      recalc();
    });
  });

  // consumer inline actions
  document.querySelectorAll('.consumer').forEach(div=>{
    const pIdx = +div.dataset.p;
    const cIdx = +div.dataset.c;
    const qtyEl = div.querySelector('.cons-qty');
    const usageEl = div.querySelector('.cons-usage');
    const rm = div.querySelector('.remove-consumer');

    if(qtyEl) qtyEl.addEventListener('input', ()=>{ pieces[pIdx].consumers[cIdx].qty = Math.max(0, Number(qtyEl.value||0)); renderSubtitlesFromPieces(); recalc(); });
    if(usageEl) usageEl.addEventListener('change', ()=>{ pieces[pIdx].consumers[cIdx].usage = usageEl.value; renderSubtitlesFromPieces(); recalc(); });
    if(rm) rm.addEventListener('click', ()=>{ pieces[pIdx].consumers[cIdx].qty = 0; pieces[pIdx].consumers.splice(cIdx,1); renderPieces(); renderSubtitlesFromPieces(); recalc(); });
  });
}

/* ------------------------------
   Calcul principal (avec plages & duty cycles, calcule min/avg/max)
   ------------------------------ */

function getNominalPower(cat, selectedSize, mode='avg'){
  if(!cat || !cat.sizes || !selectedSize) return 0;
  const val = cat.sizes[selectedSize];
  if(typeof val === 'number') return val;
  if(val && typeof val === 'object'){
    const min = Number(val.min||0), max = Number(val.max||min);
    if(mode === 'min') return min;
    if(mode === 'max') return max;
    return (min + max) / 2; // avg par d√©faut
  }
  return 0;
}

function getActiveConsumers(){
  if(pieces.length){
    const list = [];
    pieces.forEach(p=>{
      p.consumers.forEach(c=>{
        list.push({...c, _room: p.id});
      });
    });
    return list;
  }
  return items.slice();
}

// Calcule factures (mensuel/bimensiel/hebdo) pour un kWh/month donn√©
function billForConsumption(totalKwhMonth, tarifValue, cityValue){
  const sel = tarifValue || '';
  let montantMensuel = 0, montantBimestriel = 0, montantHebdo = 0;
  if(sel.startsWith('ci|')){
    const key = sel.split('|')[1];
    const isAbidjan = (cityValue === 'ci_abidjan');
    // computeCIBill expects bimestrial kWh
    const bimKwh = totalKwhMonth * 2;
    const res = computeCIBill(bimKwh, key, { puissanceSouscrite_kW:1, isAbidjan });
    montantBimestriel = res.total_bi; montantMensuel = res.total_mois; montantHebdo = res.total_hebdo;
  } else if(sel.startsWith('sn|')){
    const key = sel.split('|')[1];
    const res = computeSNBill(totalKwhMonth, key);
    montantMensuel = res.total_mois; montantBimestriel = res.total_bi; montantHebdo = res.total_hebdo;
  } else {
    const price_ht = 95; const energy_ht_month = totalKwhMonth * price_ht; const tva = energy_ht_month * 0.18;
    montantMensuel = energy_ht_month + tva; montantBimestriel = montantMensuel * 2; montantHebdo = montantMensuel / 4;
  }
  return { montantMensuel, montantBimestriel, montantHebdo };
}

function recalc(){
  const consumers = getActiveConsumers();

  // helper to compute totalWhPerDay given mode 'min'|'avg'|'max'
  function computeTotalWhPerDayForMode(mode){
    let totalWhPerDay = 0;
    consumers.forEach(it=>{
      const qty = Number(it.qty||0);
      if(qty <= 0) return;
      const cat = catalogue.find(c=>c.id === it.id);

      // determine power W based on mode
      let power = 0;
      if(cat && cat.variantType === 'size' && it.selectedSize){
        power = getNominalPower(cat, it.selectedSize, mode);
      } else if(cat && cat.variantType === 'brand' && it.selectedBrand){
        power = (cat.brands && cat.brands[it.selectedBrand]) ? Number(cat.brands[it.selectedBrand]) : Number(cat.powerW||0);
      } else {
        power = Number(it.powerW || (cat?cat.powerW:0)) || 0;
      }

      const usageFactor = usageFactors[it.usage] || 1;

      // hours on
      let hoursOn = 0;
      const isCycling = !!(cat && cat.cycling);
      if(isCycling){
        // dutyCycle is not usually a range here; keep same duty for min/avg/max
        let duty = Number(it.dutyCycle || 0) || 0;
        if(!duty){
          const map = DEFAULT_DUTY_CYCLES[cat.id];
          duty = (map && map[it.selectedSize]) ? map[it.selectedSize] : 0.4;
        }
        hoursOn = 24 * duty * usageFactor;
      } else {
        hoursOn = (Number(it.hours) || 0) * usageFactor;
      }

      totalWhPerDay += power * qty * hoursOn;
    });

    if(enableAutres.checked){
      const aq = Number(autresQty.value||0), ap = Number(autresPower.value||0), ah = Number(autresH.value||0);
      totalWhPerDay += aq * ap * ah;
    }

    // consider inverter/system losses
    const pertes = 10;
    const totalWhPerDayEff = totalWhPerDay / (1 - pertes/100);
    return totalWhPerDayEff;
  }

  const totalWhMin = computeTotalWhPerDayForMode('min');
  const totalWhAvg = computeTotalWhPerDayForMode('avg');
  const totalWhMax = computeTotalWhPerDayForMode('max');

  const jours = 30;
  const totalKwhMonthMin = totalWhMin * jours / 1000;
  const totalKwhMonthAvg = totalWhAvg * jours / 1000;
  const totalKwhMonthMax = totalWhMax * jours / 1000;

  // billing results
  const tarifSel = tarifSelect.value || '';
  const cityVal = citySelect.value || '';

  const billMin = billForConsumption(totalKwhMonthMin, tarifSel, cityVal);
  const billAvg = billForConsumption(totalKwhMonthAvg, tarifSel, cityVal);
  const billMax = billForConsumption(totalKwhMonthMax, tarifSel, cityVal);

  // Update UI: show avg and range (min - max)
  consMonthEl.innerText = fmt(totalKwhMonthAvg,2) + ' kWh';
  consMonthRangeEl.innerText = `plage: ${fmt(totalKwhMonthMin,2)} - ${fmt(totalKwhMonthMax,2)} kWh`;

  montantMensEl.innerText = fcfa(Math.round(billAvg.montantMensuel));
  montantMensRangeEl.innerText = `plage: ${fcfa(Math.round(billMin.montantMensuel))} - ${fcfa(Math.round(billMax.montantMensuel))}`;

  montantBiEl.innerText = fcfa(Math.round(billAvg.montantBimestriel));
  montantBiRangeEl.innerText = `plage: ${fcfa(Math.round(billMin.montantBimestriel))} - ${fcfa(Math.round(billMax.montantBimestriel))}`;

  montantHebdoEl.innerText = fcfa(Math.round(billAvg.montantHebdo));
  montantHebdoRangeEl.innerText = `plage: ${fcfa(Math.round(billMin.montantHebdo))} - ${fcfa(Math.round(billMax.montantHebdo))}`;

  // store last calculation snapshot for PDF export
  lastCalcSnapshot = {
    totalKwhMonth: totalKwhMonthAvg,
    totalKwhMonthMin,
    totalKwhMonthMax,
    billAvg, billMin, billMax
  };
}

/* store snapshot for PDF */
let lastCalcSnapshot = null;

/* ------------------------------
   Reset
   ------------------------------ */
function resetAll(){
  if(!confirm('R√©initialiser tous les param√®tres (pi√®ces, consommateurs globaux, autres) ?')) return;
  items = catalogue.map(c => ({
    ...c,
    qty:0, usage:'Tous les jours',
    selectedSize: c.defaultSize || (c.sizes? Object.keys(c.sizes)[0] : undefined),
    selectedBrand: c.defaultBrand || (c.brands? Object.keys(c.brands)[0] : undefined)
  }));
  pieces = [];
  enableAutres.checked=false; autresPanel.style.display='none'; autresQty.value=0; autresPower.value=0; autresH.value=0;
  zoneSelect.value='ci'; populateTarifs(zoneSelect.value);
  renderPieces();
  renderSubtitlesFromPieces();
  recalc();
}

/* ------------------------------
   Export PDF (inclut plages)
   ------------------------------ */
async function generatePDF(){
  const pdfContainer = document.createElement('div');
  pdfContainer.style.width = '794px';
  pdfContainer.style.minHeight = '1123px';
  pdfContainer.style.background = '#fff';
  pdfContainer.style.color = '#072012';
  pdfContainer.style.fontFamily = 'Poppins, Arial, sans-serif';
  pdfContainer.style.padding = '28px';
  pdfContainer.style.position = 'fixed';
  pdfContainer.style.left = '-2000px';
  pdfContainer.style.top = '20px';
  pdfContainer.id = 'pdfSummary';

  // watermark
  const watermark = document.createElement('div');
  watermark.innerText = 'GREENBRIDGE';
  watermark.style.position = 'absolute';
  watermark.style.left = '50%';
  watermark.style.top = '45%';
  watermark.style.transform = 'translate(-50%,-50%) rotate(-30deg)';
  watermark.style.fontSize = '96px';
  watermark.style.opacity = '0.06';
  watermark.style.color = '#000';
  watermark.style.fontWeight = '800';
  pdfContainer.appendChild(watermark);

  const zoneVal = (zoneSelect && zoneSelect.value) ? zoneSelect.value : 'ci';
  const countryMap = { 'ci': {name:'C√¥te d\'Ivoire', flag:'üá®üáÆ'}, 'sn': {name:'S√©n√©gal', flag:'üá∏üá≥'} };
  const country = countryMap[zoneVal] || { name: 'Pays', flag: '' };

  // tariff label
  let tarifLabel = '';
  try {
    tarifLabel = (tarifSelect && tarifSelect.selectedIndex >= 0) ? tarifSelect.options[tarifSelect.selectedIndex].text : '';
  } catch(e){ tarifLabel = ''; }

  const header = document.createElement('div');
  header.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:26px;font-weight:800;color:#072012">GREENBRIDGE</div>
        <div style="font-size:14px;color:#6b7f6b">Synth√®se de consommation ‚Äî √Ä TITRE INDICATIF</div>
      </div>

      <div style="text-align:right;font-size:12px;color:#6b7f6b">
        <div>${new Date().toLocaleString('fr-FR')}</div>
        <div style="margin-top:6px;font-weight:700">${country.flag} ${country.name}</div>
        <div style="margin-top:4px;font-size:12px;color:#444">Type tarifaire / compteur : <strong>${tarifLabel || '‚Äî'}</strong></div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #eee;margin:8px 0 16px 0" />
  `;
  pdfContainer.appendChild(header);

  // content
  if(pieces.length){
    pieces.forEach(p=>{
      const title = document.createElement('div');
      title.style.marginTop = '8px';
      title.innerHTML = `<div style="font-weight:800">${p.id} ‚Äî ${p.type}</div>`;
      pdfContainer.appendChild(title);
      if(p.consumers.length === 0){
        const em = document.createElement('div'); em.style.fontSize='12px'; em.style.color='#666'; em.innerText='(Aucun consommateur ajout√©)';
        pdfContainer.appendChild(em);
      } else {
        const table = document.createElement('table');
        table.style.width='100%'; table.style.borderCollapse='collapse';
        const rows = p.consumers.map(c=>`<tr><td style="padding:6px;border-bottom:1px solid #eee">${c.label}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${c.qty}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${c.usage}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${c.variantLabel||''}</td></tr>`).join('');
        table.innerHTML = `<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">√âquipement</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Qt√©</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Fr√©quence</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Taille/Marque</th></tr></thead><tbody>${rows}</tbody>`;
        pdfContainer.appendChild(table);
      }
    });
  } else {
    const table = document.createElement('table');
    table.style.width='100%'; table.style.borderCollapse='collapse';
    const rows = items.map(it=>`<tr><td style="padding:6px;border-bottom:1px solid #eee">${it.label}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${it.qty}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${it.usage}</td><td style="text-align:center;padding:6px;border-bottom:1px solid #eee">${it.variantType==='size'?it.selectedSize:(it.variantType==='brand'?it.selectedBrand:'')}</td></tr>`).join('');
    table.innerHTML = `<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #eee">√âquipement</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Qt√©</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Fr√©quence</th><th style="text-align:center;padding:6px;border-bottom:1px solid #eee">Taille/Marque</th></tr></thead><tbody>${rows}</tbody>`;
    pdfContainer.appendChild(table);
  }

  // summary block with ranges
  const snapshot = lastCalcSnapshot || { totalKwhMonth:0, totalKwhMonthMin:0, totalKwhMonthMax:0, billAvg:{montantMensuel:0,montantBimestriel:0,montantHebdo:0}, billMin:{montantMensuel:0,montantBimestriel:0,montantHebdo:0}, billMax:{montantMensuel:0,montantBimestriel:0,montantHebdo:0} };

  const summaryBlock = document.createElement('div');
  summaryBlock.style.marginTop = '18px';
  summaryBlock.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:180px;padding:10px;border-radius:8px;background:#f7f7f7">
        <div style="font-size:12px;color:#6b7f6b">Consommation (kWh / mois)</div>
        <div style="font-weight:800;font-size:18px;margin-top:6px">${fmt(snapshot.totalKwhMonth,2)} kWh</div>
        <div style="font-size:12px;color:#6b7f6b;margin-top:6px">plage: ${fmt(snapshot.totalKwhMonthMin,2)} - ${fmt(snapshot.totalKwhMonthMax,2)} kWh</div>
      </div>

      <div style="flex:1;min-width:180px;padding:10px;border-radius:8px;background:#f7f7f7">
        <div style="font-size:12px;color:#6b7f6b">Montant (mensuel)</div>
        <div style="font-weight:800;font-size:18px;margin-top:6px">${fcfa(Math.round(snapshot.billAvg.montantMensuel))}</div>
        <div style="font-size:12px;color:#6b7f6b;margin-top:6px">plage: ${fcfa(Math.round(snapshot.billMin.montantMensuel))} - ${fcfa(Math.round(snapshot.billMax.montantMensuel))}</div>
      </div>

      <div style="flex:1;min-width:180px;padding:10px;border-radius:8px;background:#fff8e6;border:1px solid #f0e0b0">
        <div style="font-size:12px;color:#6b7f6b">Montant (bimensiel)</div>
        <div style="font-weight:900;font-size:18px;margin-top:6px;color:#b37400">${fcfa(Math.round(snapshot.billAvg.montantBimestriel))}</div>
        <div style="font-size:12px;color:#6b7f6b;margin-top:6px">plage: ${fcfa(Math.round(snapshot.billMin.montantBimestriel))} - ${fcfa(Math.round(snapshot.billMax.montantBimestriel))}</div>
      </div>

      <div style="flex:1;min-width:180px;padding:10px;border-radius:8px;background:#f7f7f7">
        <div style="font-size:12px;color:#6b7f6b">Montant (hebdo)</div>
        <div style="font-weight:800;font-size:18px;margin-top:6px">${fcfa(Math.round(snapshot.billAvg.montantHebdo))}</div>
        <div style="font-size:12px;color:#6b7f6b;margin-top:6px">plage: ${fcfa(Math.round(snapshot.billMin.montantHebdo))} - ${fcfa(Math.round(snapshot.billMax.montantHebdo))}</div>
      </div>
    </div>
  `;
  pdfContainer.appendChild(summaryBlock);

  const note = document.createElement('div');
  note.style.marginTop = '20px';
  note.style.fontSize = '12px';
  note.style.color = '#6b7f6b';
  note.innerHTML = `<hr style="border:none;border-top:1px solid #eee;margin:12px 0" />
    <div><strong>Remarques :</strong> Document √† titre indicatif ‚Äî ne constitue pas un devis contractuel. Calcul bas√© sur des hypoth√®ses internes (puissances, heures, duty cycles). Pour une √©tude pr√©cise, contactez GreenBridge.</div>`;
  pdfContainer.appendChild(note);

  document.body.appendChild(pdfContainer);
  exportPdfBtn.disabled = true; exportPdfBtn.innerText = 'G√©n√©ration...';
  try{
    const scale = 2;
    const canvas = await html2canvas(pdfContainer, { scale, useCORS:true, logging:false, backgroundColor: '#ffffff' });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4', orientation:'portrait' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const imgProps = { width: canvas.width, height: canvas.height };
    const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
    const imgW = imgProps.width * ratio;
    const imgH = imgProps.height * ratio;
    doc.addImage(imgData, 'JPEG', (pageWidth - imgW)/2, 20, imgW, imgH, undefined, 'FAST');
    const footerY = pageHeight - 30;
    doc.setFontSize(9); doc.setTextColor(120); doc.text('GreenBridge ‚Äî Document √† titre indicatif', 40, footerY);
    const fileName = 'GreenBridge_synthese_' + (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-') + '.pdf';
    doc.save(fileName);
  } catch(err){
    console.error(err);
    alert('Erreur lors de la g√©n√©ration du PDF.');
  } finally {
    exportPdfBtn.disabled = false; exportPdfBtn.innerText = 'Exporter (PDF)';
    const el = document.getElementById('pdfSummary'); if(el) el.remove();
  }
}

/* ------------------------------
   Wiring & interactions
   ------------------------------ */
enableAutres.addEventListener('change', ()=>{ autresPanel.style.display = enableAutres.checked ? 'block' : 'none'; recalc();});
[autresQty,autresPower,autresH].forEach(el=>el.addEventListener('input', recalc));
zoneSelect.addEventListener('change', ()=>populateTarifs(zoneSelect.value));
tarifSelect.addEventListener('change', recalc);
citySelect.addEventListener('change', ()=>{ zoomToCity(citySelect.value); recalc(); });
resetBtn.addEventListener('click', resetAll);
exportPdfBtn.addEventListener('click', generatePDF);

generateBtn.addEventListener('click', ()=>{
  const counts = {
    bedrooms: Math.max(0, Number(genBedrooms.value||0)),
    living: Math.max(0, Number(genLiving.value||0)),
    kitchens: Math.max(0, Number(genKitchens.value||0)),
    baths: Math.max(0, Number(genBaths.value||0)),
    offices: Math.max(0, Number(genOffices.value||0)),
    toilets: Math.max(0, Number(genToilets.value||0))
  };
  const add = genAdd.checked;
  if(!add) pieces = [];
  for(let i=0;i<counts.bedrooms;i++) addPieces('Chambre', 'Chambre', 1, true);
  for(let i=0;i<counts.living;i++) addPieces('Salon', 'Salon', 1, true);
  for(let i=0;i<counts.kitchens;i++) addPieces('Cuisine', 'Cuisine', 1, true);
  for(let i=0;i<counts.baths;i++) addPieces("Salle d'eau", "Salle d'eau", 1, true);
  for(let i=0;i<counts.offices;i++) addPieces('Bureau', 'Bureau', 1, true);
  for(let i=0;i<counts.toilets;i++) addPieces('Toilette', 'Toilette', 1, true);
  renderPieces(); renderSubtitlesFromPieces(); recalc();
});

addRoomsBtn.addEventListener('click', ()=>{
  const type = roomTypeSelect.value || 'Autre';
  const count = Math.max(1, Number(roomCountInput.value||1));
  const baseName = roomNameInput.value && roomNameInput.value.trim() ? roomNameInput.value.trim() : type;
  addPieces(type, baseName, count, true);
});

clearRoomsBtn.addEventListener('click', clearPieces);

/* populate tarifs */
function populateTarifs(zone){
  tarifSelect.innerHTML = '';
  citySelect.innerHTML = '';
  if(zone === 'ci'){
    citySelect.appendChild(new Option("C√¥te d'Ivoire (toutes villes)", 'ci_all'));
    citySelect.appendChild(new Option("Abidjan", 'ci_abidjan'));
    citySelect.appendChild(new Option("Yamoussoukro", 'ci_yamoussoukro'));
    Object.keys(CI_TARIFFS).forEach(k=> tarifSelect.appendChild(new Option(CI_TARIFFS[k].label, 'ci|'+k)));
    citySelect.value='ci_abidjan';
  } else {
    citySelect.appendChild(new Option("S√©n√©gal (toutes villes)", 'sn_all'));
    citySelect.appendChild(new Option("Dakar", 'sn_dakar'));
    Object.keys(SN_TARIFFS).forEach(k=> tarifSelect.appendChild(new Option(SN_TARIFFS[k].label, 'sn|'+k)));
    citySelect.value='sn_dakar';
  }
  zoomToCity(citySelect.value);
  recalc();
}

/* mobile menu toggle */
menuBtn.addEventListener('click', ()=>{
  if(mainNav.style.display === 'block') mainNav.style.display = 'none';
  else mainNav.style.display = 'block';
});

/* ---------- Init ---------- */
function init(){ initMap(); populateTarifs(zoneSelect.value); renderPieces(); renderSubtitlesFromPieces(); recalc(); }
init();
</script>
</body>
</html>

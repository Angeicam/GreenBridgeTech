<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GreenBridge — Calculateur consommation (intégration tailles & marques)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --topbar-h:48px; --header-h:72px;
  --bg:#0a4d2e; --green-mid:#073217; --accent:#7cb342; --muted:#e6f7ea; --gold:#d4af37;
  --card-radius:12px; --font: 'Poppins', Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:var(--bg);color:#fff;scroll-behavior:smooth}
a{color:inherit;text-decoration:none}

/* topbar/header */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:rgba(6,31,20,0.98);display:flex;align-items:center;justify-content:space-between;padding:0 5vw;z-index:2000;font-size:14px}
.topbar .left, .topbar .right{display:flex;gap:12px;align-items:center}
.topbar i{margin-right:6px}
header{position:fixed;top:var(--topbar-h);left:0;right:0;height:var(--header-h);background:linear-gradient(90deg,var(--green-mid),#0b4d26);display:flex;align-items:center;justify-content:space-between;padding:0 5vw;z-index:1999;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.logo-text{display:flex;align-items:center;gap:12px}
.logo-text img{height:56px}
.company-name{font-size:28px;font-weight:800;color:#04462e;-webkit-text-stroke:0.9px var(--gold);padding:6px 10px;border-radius:8px}

/* electric orbs - make sure they're in front */
.electric-band{position:fixed;top:calc(var(--topbar-h) + var(--header-h) - 6px);left:0;right:0;height:14px;z-index:2200;pointer-events:none}
.electric-band .container{position:absolute;left:0;top:50%;transform:translateY(-50%);width:100vw;height:100%}
.lightning-svg{width:100vw;height:100%;display:block;pointer-events:none;mix-blend-mode:screen}
.orbs{position:absolute;left:0;top:0;width:100vw;height:100%;pointer-events:none;overflow:visible}
.orb{position:absolute;width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8b0, var(--gold));box-shadow:0 0 10px rgba(255,214,0,0.9),0 0 24px rgba(255,214,0,0.12);transform:translate(-50%,-50%);opacity:0}
.electric-band.active .orb{opacity:1}
.orb.buzz{animation:orb-buzz 1.8s linear infinite}
@keyframes orb-buzz{0%{transform:translate(-50%,-50%) translateX(-1.6px)}50%{transform:translate(-50%,-50%) translateX(1.6px)}100%{transform:translate(-50%,-50%) translateX(-1.6px)}}
.glowline{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);height:3px;width:0;background:linear-gradient(90deg, rgba(255,238,170,0), var(--gold), rgba(255,238,170,0));border-radius:8px;opacity:0}
.electric-band.active .glowline{width:100vw;opacity:1;animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scaleX(.7);opacity:.6}50%{transform:translate(-50%,-50%) scaleX(1);opacity:1}100%{transform:translate(-50%,-50%) scaleX(.7);opacity:.6}}

/* main layout */
.main{margin-top:calc(var(--topbar-h) + var(--header-h));padding:18px 5vw 80px;max-width:1200px;margin-left:auto;margin-right:auto}
.hero{background:url('chantier_solaire.png') center/cover no-repeat;border-radius:12px;padding:18px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.hero h1{margin:0;font-size:24px}
.grid{display:grid;grid-template-columns:1fr;gap:18px;margin-top:12px}

/* map + calc card */
.card{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
#map{height:220px;border-radius:8px;overflow:hidden}

/* calc inner */
.calc{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;margin-top:8px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
.calc h3{margin:0;color:#04462e;font-size:16px}
.small-note{font-size:12px;color:#6b7f6b;margin-top:8px}

/* table items (only user sees qty, usage, size/brand selects) */
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table td{padding:8px;border-top:1px solid rgba(0,0,0,0.06);vertical-align:middle;font-size:14px;color:#072012}
.icon{width:60px;text-align:center}
.icon .circle{width:38px;height:38px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#072012}
.qty{width:80px;text-align:center}
.usage{width:170px}

/* result cards */
.results{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.result-card{background:rgba(0,0,0,0.03);padding:12px;border-radius:8px;flex:1;text-align:center;min-width:170px}
.result-card .label{font-size:13px;color:#6b7f6b}
.result-card .value{font-weight:800;font-size:18px;color:#04462e;margin-top:6px}

/* footer */
.footer{margin-top:20px;padding:24px 0;text-align:center;color:#fff}
.footer .brand{font-weight:800;display:block;margin-bottom:6px}
.footer .small{font-size:13px;opacity:0.95}

/* responsive */
@media(min-width:900px){
  .grid{grid-template-columns: 1fr}
}
@media(max-width:700px){
  #map{height:200px}
  .icon .circle{width:30px;height:30px}
}
</style>
</head>
<body>

<!-- topbar/header -->
<div class="topbar">
  <div class="left"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Abidjan, Côte d’Ivoire</div>
  <div class="right"><i class="fas fa-phone" aria-hidden="true"></i> +225 07 07 07 07 07</div>
</div>

<header>
  <div class="logo-text">
    <a href="#"><img src="green bridge domo.png" alt="logo"></a>
    <div class="company-name">GREENBRIDGE</div>
  </div>
  <nav>
    <a href="#" class="active">Accueil</a>
    <a href="#">Énergie</a>
    <a href="#">Domotique</a>
    <a href="#">Sécurité</a>
    <a href="#">Maintenance</a>
  </nav>
</header>

<!-- orbs (front) -->
<div class="electric-band" id="energyBand" aria-hidden="true">
  <div class="container">
    <svg class="lightning-svg" viewBox="0 0 2000 40" preserveAspectRatio="none"><path class="zap" d="M10,22 C260,6 520,36 840,20 C1120,8 1440,34 1760,18 C1880,6 1960,28 1990,22" stroke-opacity="0.14"/><path class="zap" d="M10,24 C280,36 600,6 860,22 C1140,36 1460,6 1800,22 C1880,36 1960,10 1990,22" stroke-opacity="0.10"/><path class="bright" id="zapBright" d="M20,22 C300,6 600,34 880,16 C1240,0 1520,32 1860,14 C1960,2 1980,30 1990,22" stroke-opacity="1" stroke-dasharray="520" stroke-dashoffset="520"/></svg>
    <div class="orbs">
      <div class="orb" id="eOrbA"></div>
      <div class="orb" id="eOrbB"></div>
      <div class="orb" id="eOrbC"></div>
    </div>
    <div class="glowline" id="eGlowline"></div>
  </div>
</div>

<main class="main">
  <section class="hero card">
    <h1>Panneaux Solaires & Calculateur simplifié</h1>
    <p style="margin-top:6px;color:#3d5b3f">Estimation indicative — pour une étude précise, contactez notre Bureau d'Étude GreenBridge.</p>
  </section>

  <div class="grid">
    <!-- Map card -->
    <div class="card" id="mapCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:#072012">Nos zones d'intervention</strong>
        <small style="color:#666">Abidjan • Yamoussoukro • Dakar</small>
      </div>
      <div id="map" style="margin-top:10px"></div>

      <!-- Calculator directly under map (visible) -->
      <div class="calc" id="calcCard">
        <h3>Calculateur rapide — Consommation</h3>
        <div class="small-note">Saisissez uniquement les quantités et le mode d'utilisation (taille/marque quand demandé). Hypothèses techniques internes (puissances/heures) — résultats indicatifs.</div>

        <!-- zone & tariff -->
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#072012">Zone :</label>
          <select id="zone" style="padding:6px;border-radius:6px">
            <option value="ci">Côte d'Ivoire (Abidjan / Yamoussoukro)</option>
            <option value="sn">Sénégal (Dakar)</option>
          </select>

          <label style="font-size:13px;color:#072012">Type tarifaire :</label>
          <select id="tarif" style="padding:6px;border-radius:6px;min-width:300px"></select>
        </div>

        <!-- items table -->
        <table class="table" aria-hidden="false">
          <tbody id="itemsBody"></tbody>
        </table>

        <!-- autres (large power) -->
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="enableAutres"><label for="enableAutres" style="color:#072012">Saisir "Autres (Grande puissance)"</label>
        </div>
        <div id="autresPanel" style="display:none;margin-top:8px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <label style="font-size:13px;color:#072012">Qté</label><input id="autresQty" class="qty" type="number" value="0" min="0" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
            <label style="font-size:13px;color:#072012">Puissance (W)</label><input id="autresPower" class="qty" type="number" value="250" style="width:100px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
            <label style="font-size:13px;color:#072012">Heures/j</label><input id="autresH" class="qty" type="number" value="3" step="0.1" style="width:90px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          </div>
        </div>

        <!-- results -->
        <div class="results">
          <div class="result-card">
            <div class="label">Consommation (kWh / mois)</div>
            <div id="consMonth" class="value">0 kWh</div>
          </div>
          <div class="result-card">
            <div class="label">Montant (mensuel)</div>
            <div id="montantMens" class="value">0 FCFA</div>
          </div>
          <div class="result-card">
            <div class="label">Montant (bimensuel)</div>
            <div id="montantBi" class="value">0 FCFA</div>
          </div>
          <div class="result-card">
            <div class="label">Montant (hebdo)</div>
            <div id="montantHebdo" class="value">0 FCFA</div>
          </div>
        </div>

        <div class="small-note" style="margin-top:8px">Note : Les puissances & heures sont des hypothèses internes du Bureau d'étude GreenBridge. Résultats indicatifs — contactez-nous pour une étude détaillée.</div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="brand">GREENBRIDGE</div>
    <div class="small">© 2025 GreenBridge Énergie — Abidjan, Côte d’Ivoire — Tel: +225 07 07 07 07 07.</div>
  </footer>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- Map (compact) ---------- */
(function(){
  try {
    const map = L.map('map', { dragging:true, zoomControl:true, attributionControl:false }).setView([6.5, -5.0], 6.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
    const pin = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[22,22], iconAnchor:[11,22] });
    const villes = [
      {nom:"Abidjan", lat:5.345317, lng:-4.024429},
      {nom:"Yamoussoukro", lat:6.818351, lng:-5.276987},
      {nom:"Dakar", lat:14.6937, lng:-17.44406}
    ];
    villes.forEach(v => L.marker([v.lat,v.lng],{icon:pin}).addTo(map).bindTooltip(v.nom));
    map.fitBounds(L.latLngBounds(villes.map(v=>[v.lat,v.lng])), {padding:[20,20]});
  } catch(e){ console.warn(e) }
})();

/* ---------- Orbs ---------- */
(function(){
  const band = document.getElementById('energyBand');
  if(!band) return;
  const a = document.getElementById('eOrbA'), b = document.getElementById('eOrbB'), c = document.getElementById('eOrbC');
  [a,b,c].forEach((o,i)=>{ if(o){ o.classList.add('buzz'); o.style.opacity='1'; o.style.animationDelay=(i*120)+'ms'; }});
  let t0 = performance.now();
  const params = [{r:0.5,ry:8,s:0.06,p:0},{r:0.33,ry:6,s:0.08,p:Math.PI/2},{r:0.42,ry:10,s:0.05,p:Math.PI}];
  function tick(now){
    const time=(now-t0)/1000; const cont = band.querySelector('.container');
    if(!cont){ requestAnimationFrame(tick); return; }
    const rect = cont.getBoundingClientRect(); const cx = rect.width/2; const cy = rect.height/2;
    [a,b,c].forEach((o,i)=>{ if(!o) return; const p=params[i]; const rx = Math.max(Math.min(rect.width * p.r, 4000), 120); const ang = (time * p.s * Math.PI * 2) + p.p; const x = cx + Math.cos(ang) * rx; const y = cy + Math.sin(ang) * p.ry; o.style.left = x + 'px'; o.style.top = y + 'px'; o.style.transform='translate(-50%,-50%)'; });
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
  band.classList.add('active');
})();

/* ---------- Items definitions (with sizes & brands) ---------- */
/*
- For each item: default hidden powers/hours are stored inside. User only sees qty, usage and selects (size or brand) where relevant.
- Sizes and brands map to power (W) and optional hours override.
*/

const items = [
  // Eclairage: fixed LED/Fluo (20W), qty and usage
  { id:'eclairage', label:'Éclairage • LED/Fluo', icon:'fa-lightbulb', color:'#ffd54f',
    qty:18, usage:'Tous les jours',
    variantType:'none',
    powerW:20, hours:4 },

  // Ventilation: has size variants (Petit/Moyen/Grand) and ceiling fan
  { id:'ventilation', label:'Ventilation', icon:'fa-fan', color:'#90caf9',
    qty:2, usage:'Régulier',
    variantType:'size',
    sizes: { 'Petit':50, 'Moyen':75, 'Grand':100 },
    selectedSize:'Moyen', hours:8 },

  { id:'vent_plafond', label:'Ventilateur Plafond', icon:'fa-fan', color:'#80deea',
    qty:0, usage:'Full',
    variantType:'size',
    sizes: { 'Plafond':120 },
    selectedSize:'Plafond', hours:3 },

  // Climatisation: brand variants (Nasco / TCL / Samsung / Smart)
  { id:'clim', label:'Climatisation • Climatiseur', icon:'fa-snowflake', color:'#b39ddb',
    qty:1, usage:'Rare',
    variantType:'brand',
    brands: { 'Nasco':1120, 'TCL':1133, 'Samsung':1000, 'Smart':1120 },
    selectedBrand:'Nasco', hours:8 },

  // Ordinateurs & mobiles
  { id:'phone', label:'Téléphone portable', icon:'fa-mobile-screen', color:'#a5d6a7', qty:8, usage:'Tous les jours', variantType:'none', powerW:30, hours:2 },
  { id:'tablet', label:'Tablette', icon:'fa-tablet-screen', color:'#c5e1a5', qty:0, usage:'Occasionnel', variantType:'none', powerW:65, hours:1 },
  { id:'pcp', label:'PC portable', icon:'fa-laptop', color:'#ffe082', qty:2, usage:'Régulier', variantType:'none', powerW:85, hours:1 },
  { id:'pcb', label:'PC Bureau', icon:'fa-desktop', color:'#ffd3b6', qty:0, usage:'Régulier', variantType:'none', powerW:170, hours:0.25 },

  // TV / HIFI
  { id:'tv', label:'TV • Ecran plat', icon:'fa-tv', color:'#ffab91', qty:1, usage:'Tous les jours', variantType:'none', powerW:150, hours:4 },

  // Divers
  { id:'decodeur', label:'Décodeur DSL/ADSL', icon:'fa-wifi', color:'#ce93d8', qty:1, usage:'Tous les jours', variantType:'none', powerW:45, hours:24 },

  // Frigo / congel
  { id:'frigo', label:'Réfrigérateur • Grand', icon:'fa-box-archive', color:'#a7ffeb', qty:1, usage:'Tous les jours',
    variantType:'size', sizes:{ 'Petit':125, 'Moyen':150, 'Grand':175 }, selectedSize:'Grand', hours:24 },
  { id:'congel', label:'Congélateur • Grand', icon:'fa-snowflake', color:'#b2ebf2', qty:0, usage:'Tous les jours',
    variantType:'size', sizes:{ 'Petit':175, 'Moyen':195, 'Grand':225 }, selectedSize:'Grand', hours:24 },

  // Electromenager
  { id:'seche', label:'Sèche Cheveux', icon:'fa-wind', color:'#ffcc80', qty:0, usage:'Full', variantType:'none', powerW:2000, hours:0.25 },
  { id:'micro', label:'Micro-Onde', icon:'fa-burn', color:'#ffd180', qty:0, usage:'Full', variantType:'none', powerW:900, hours:0.25 },
  { id:'cafe', label:'Cafetière / Bouilloire', icon:'fa-mug-hot', color:'#ffecb3', qty:0, usage:'Full', variantType:'none', powerW:1500, hours:0.05 },
  { id:'robot', label:'Robot / Mixeur', icon:'fa-blender', color:'#c8e6c9', qty:0, usage:'Full', variantType:'none', powerW:500, hours:0.05 },

  // Others (user fills)
  { id:'autres', label:'Autres (Grande puissance)', icon:'fa-bolt', color:'#ffd1dc', qty:0, usage:'Full', variantType:'custom', powerW:250, hours:3 }
];

/* usage factors (hidden) */
const usageFactors = {'Tous les jours':1,'Régulier':0.6,'Occasionnel':0.2,'Rare':0.05,'Full':1};

/* tariffs (CI & SN presets) */
const CI_TARIFFS = {
  'CI_ref_95': {label:'CI — Référence 95 FCFA/kWh', price_ht:95, prime_bi:1371.22},
  'CI_social_5A': {label:'CI — Social 5A (ex.)', price_ht:31.72, prime_bi:614.90},
  'CI_15A_dom': {label:'CI — Domestique 15A', price_ht:81.03, prime_bi:1508.34}
};
const SN_TARIFFS = {
  'SN_UD_DPP': {label:'SN — UD — DPP', prices:[91.17,136.49,159.36], tr:[150,200], prime_mois:0},
  'SN_UD_DMP': {label:'SN — UD — DMP', prices:[111.23,143.54,158.46], tr:[50,300], prime_mois:0},
  'SN_PREPAY_DPP': {label:'SN — Prépayé DPP', prices:[91.17,136.49,149.06], tr:[150,200], prime_mois:0},
  'SN_UP_PPP': {label:'SN — UP — PPP', prices:[163.81,189.84,198.68], tr:[50,500], prime_mois:0}
};

/* DOM refs */
const itemsBody = document.getElementById('itemsBody');
const tarifSelect = document.getElementById('tarif');
const zoneSelect = document.getElementById('zone');
const consMonthEl = document.getElementById('consMonth');
const montantMensEl = document.getElementById('montantMens');
const montantBiEl = document.getElementById('montantBi');
const montantHebdoEl = document.getElementById('montantHebdo');
const enableAutres = document.getElementById('enableAutres');
const autresPanel = document.getElementById('autresPanel');
const autresQty = document.getElementById('autresQty');
const autresPower = document.getElementById('autresPower');
const autresH = document.getElementById('autresH');

/* render items: show icon, label, qty input, usage select, and when variantType=size show size select; when brand show brand select */
function renderItems(){
  itemsBody.innerHTML = '';
  items.forEach((it, idx) => {
    // skip 'autres' row (we have special panel)
    if(it.id === 'autres') return;
    const tr = document.createElement('tr');
    // prepare controls html for variants
    let variantHtml = '';
    if(it.variantType === 'size' && it.sizes){
      variantHtml = '<select data-idx="'+idx+'" class="variant-select" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">';
      Object.keys(it.sizes).forEach(sz => {
        const sel = (it.selectedSize === sz) ? 'selected' : '';
        variantHtml += `<option value="${sz}" ${sel}>${sz}</option>`;
      });
      variantHtml += '</select>';
    } else if(it.variantType === 'brand' && it.brands){
      variantHtml = '<select data-idx="'+idx+'" class="variant-brand" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">';
      Object.keys(it.brands).forEach(b => {
        const sel = (it.selectedBrand === b) ? 'selected' : '';
        variantHtml += `<option value="${b}" ${sel}>${b}</option>`;
      });
      variantHtml += '</select>';
    } else {
      variantHtml = ''; // none
    }

    tr.innerHTML = `
      <td class="icon"><span class="circle" style="background:${it.color}"><i class="fa ${it.icon}"></i></span></td>
      <td style="width:48%">${it.label}${variantHtml?('<div style="margin-top:6px">'+variantHtml+'</div>'):''}</td>
      <td class="qty"><input data-idx="${idx}" class="qty-input" type="number" min="0" value="${it.qty}" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"></td>
      <td class="usage">
        <select data-idx="${idx}" class="usage-select" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <option ${it.usage==='Tous les jours'?'selected':''}>Tous les jours</option>
          <option ${it.usage==='Régulier'?'selected':''}>Régulier</option>
          <option ${it.usage==='Occasionnel'?'selected':''}>Occasionnel</option>
          <option ${it.usage==='Rare'?'selected':''}>Rare</option>
          <option ${it.usage==='Full'?'selected':''}>Full</option>
        </select>
      </td>
    `;
    itemsBody.appendChild(tr);
  });

  // event listeners
  document.querySelectorAll('.qty-input').forEach(inp=>{
    inp.addEventListener('input', e => {
      const i = +e.target.dataset.idx; items[i].qty = Math.max(0, Number(e.target.value||0)); recalc();
    });
  });
  document.querySelectorAll('.usage-select').forEach(sel=>{
    sel.addEventListener('change', e => {
      const i = +e.target.dataset.idx; items[i].usage = e.target.value; recalc();
    });
  });
  document.querySelectorAll('.variant-select').forEach(sel=>{
    sel.addEventListener('change', e => {
      const i = +e.target.dataset.idx; items[i].selectedSize = e.target.value; recalc();
    });
  });
  document.querySelectorAll('.variant-brand').forEach(sel=>{
    sel.addEventListener('change', e => {
      const i = +e.target.dataset.idx; items[i].selectedBrand = e.target.value; recalc();
    });
  });
}

/* populate tariff dropdown */
function populateTarifs(zone){
  tarifSelect.innerHTML = '';
  if(zone === 'ci'){
    const group = document.createElement('optgroup'); group.label = "Côte d'Ivoire";
    Object.keys(CI_TARIFFS).forEach(k=>{
      const o = document.createElement('option'); o.value = 'ci|'+k; o.textContent = CI_TARIFFS[k].label; group.appendChild(o);
    });
    tarifSelect.appendChild(group);
  } else {
    const group = document.createElement('optgroup'); group.label = 'Sénégal';
    Object.keys(SN_TARIFFS).forEach(k=>{
      const o = document.createElement('option'); o.value = 'sn|'+k; o.textContent = SN_TARIFFS[k].label; group.appendChild(o);
    });
    tarifSelect.appendChild(group);
  }
  recalc();
}

/* helpers */
function fmt(n,dec=2){ return Number(n||0).toFixed(dec).replace(/\B(?=(\d{3})+(?!\d))/g,' '); }
function fcfa(n){ return Number(Math.round(n||0)).toLocaleString('fr-FR') + ' FCFA' }

/* main recalc */
function recalc(){
  // total Wh/day from hidden powers & hours, using selected sizes/brands
  let totalWhPerDay = 0;
  items.forEach(it=>{
    const qty = Number(it.qty||0);
    let power = 0;
    let hours = Number(it.hours || 0);
    if(it.variantType === 'size' && it.sizes){
      const sz = it.selectedSize || Object.keys(it.sizes)[0];
      power = it.sizes[sz];
    } else if(it.variantType === 'brand' && it.brands){
      const b = it.selectedBrand || Object.keys(it.brands)[0];
      power = it.brands[b];
    } else if(it.variantType === 'custom'){
      power = Number(it.powerW || 0);
    } else {
      power = Number(it.powerW || 0);
    }
    // For items where hours stored in object (common), use that; else if specific we used above
    totalWhPerDay += (power * hours * qty * (usageFactors[it.usage] || 1));
  });

  // include 'autres' free input panel if enabled (we also keep the 'autres' object for store)
  if(enableAutres.checked){
    const aq = Number(autresQty.value||0), ap = Number(autresPower.value||0), ah = Number(autresH.value||0);
    totalWhPerDay += aq * ap * ah;
  }

  // losses and month
  const pertes = 10; // default internal assumption
  const totalWhPerDayEff = totalWhPerDay / (1 - pertes/100);
  const jours = 30;
  const totalKwhMonth = totalWhPerDayEff * jours / 1000;

  // pricing
  const sel = tarifSelect.value || '';
  const TVA = 0.18;
  let montantMensuel = 0;
  if(sel.startsWith('ci|')){
    const key = sel.split('|')[1]; const t = CI_TARIFFS[key];
    const price_ht = t ? t.price_ht : 95;
    const prime_mois = t ? (t.prime_bi / 2) : 0;
    const energy_ht_month = totalKwhMonth * price_ht;
    const tva = energy_ht_month * TVA;
    montantMensuel = energy_ht_month + tva + prime_mois;
  } else if(sel.startsWith('sn|')){
    const key = sel.split('|')[1]; const t = SN_TARIFFS[key];
    const monthly = totalKwhMonth;
    let price = (t && t.prices) ? t.prices[t.prices.length-1] : 150;
    if(t){
      const tr1 = t.tr[0], tr2 = t.tr[1];
      if(monthly <= tr1) price = t.prices[0];
      else if(monthly <= tr2) price = t.prices[1];
      else price = t.prices[2];
    }
    const energy_ht_month = totalKwhMonth * price;
    const tva = energy_ht_month * TVA;
    montantMensuel = energy_ht_month + tva + (t.prime_mois || 0);
  } else {
    const price_ht = 95;
    const energy_ht_month = totalKwhMonth * price_ht;
    const tva = energy_ht_month * TVA;
    montantMensuel = energy_ht_month + tva;
  }

  const montantBimestriel = montantMensuel * 2;
  const montantHebdo = montantMensuel / 4;

  // write UI
  consMonthEl.innerText = fmt(totalKwhMonth,2) + ' kWh';
  montantMensEl.innerText = fcfa(montantMensuel);
  montantBiEl.innerText = fcfa(montantBimestriel);
  montantHebdoEl.innerText = fcfa(montantHebdo);
}

/* wiring */
enableAutres.addEventListener('change', ()=>{ autresPanel.style.display = enableAutres.checked ? 'block' : 'none'; recalc();});
[autresQty,autresPower,autresH].forEach(el=>el.addEventListener('input', recalc));
zoneSelect.addEventListener('change', ()=>populateTarifs(zoneSelect.value));
tarifSelect.addEventListener('change', recalc);

/* init render */
function init(){
  renderItems();
  populateTarifs(zoneSelect.value);
  recalc();
}
init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GreenBridge ‚Äî Calculateur consommation (int√©gration tailles & marques)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --topbar-h:48px; --header-h:72px;
  --green-dark:#061f14; --green-mid:#073217; --green-mid-2:#0b4d26;
  --accent:#7cb342; --accent-2:#a8e6a1; --bg:#0a4d2e; --muted:#e6f7ea; --gold:#d4af37;
  --card-radius:12px; --font: 'Poppins', Arial, sans-serif;
  --bim-bg: #fff4d0; /* plus visible bimensuel */
  --bim-text: #b37400;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:var(--bg);color:#fff;scroll-behavior:smooth}
a{color:inherit;text-decoration:none}

/* topbar/header */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:var(--green-dark);display:flex;align-items:center;justify-content:space-between;gap:20px;padding:0 5vw;z-index:1800;font-size:14px}
.topbar .left, .topbar .right{display:flex;align-items:center;gap:12px}
header{position:fixed;top:var(--topbar-h);left:0;right:0;height:var(--header-h);background:linear-gradient(90deg,var(--green-mid),var(--green-mid-2));display:flex;align-items:center;justify-content:space-between;padding:0 5vw;z-index:1750;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.logo-text{display:flex;align-items:center;gap:12px}
.logo-text img{height:56px;display:block}
.company-name{font-size:28px;font-weight:800;color:#04462e;-webkit-text-stroke:0.95px var(--gold);padding:6px 10px;border-radius:8px}

/* Nav / burger */
nav{display:flex;gap:18px;align-items:center}
nav a{color:#fff;font-size:15px;font-weight:600;padding:8px 10px;border-radius:8px;transition:all .18s;display:flex;gap:8px;align-items:center}
nav a:hover{color:var(--accent-2)}
nav a.active{color:var(--accent-2);background: linear-gradient(90deg, rgba(212,175,55,0.06), rgba(212,175,55,0.03));border:1px solid rgba(212,175,55,0.22);padding:10px 14px;font-weight:800;border-radius:10px}

/* Burger mobile: hidden on desktop, visible on small screens */
.burger{display:none;width:44px;height:44px;border-radius:8px;border:none;background:transparent;align-items:center;justify-content:center;cursor:pointer}
.burger .icon{display:block;position:relative;width:26px;height:18px}
.burger .icon span{position:absolute;left:0;right:0;height:3px;background:#fff;border-radius:2px;transition:all .25s}
.burger .icon span:nth-child(1){top:0}
.burger .icon span:nth-child(2){top:7.5px}
.burger .icon span:nth-child(3){top:15px}
.burger.open .icon span:nth-child(1){transform: translateY(7.5px) rotate(45deg)}
.burger.open .icon span:nth-child(2){opacity:0}
.burger.open .icon span:nth-child(3){transform: translateY(-7.5px) rotate(-45deg)}

.mobile-nav{display:none;position:fixed;top:calc(var(--topbar-h) + var(--header-h));left:0;right:0;background:var(--bg);z-index:1740;box-shadow:0 12px 40px rgba(0,0,0,.45);overflow:auto;max-height:0;transition:max-height .28s ease}
.mobile-nav.open{ display:block; max-height:85vh; }
.mobile-nav .inner{ padding:12px 5vw; display:flex; flex-direction:column; gap:8px; align-items:stretch; }
.mobile-nav a{ padding:12px; color:#fff; width:100%; text-align:left; border-radius:8px; font-weight:700; display:flex; justify-content:space-between; align-items:center }

/* electric band */
.electric-band{position:fixed;top:calc(var(--topbar-h) + var(--header-h) - 6px);left:0;right:0;height:14px;z-index:1900;pointer-events:none}
.electric-band .container{position:absolute;left:0;top:50%;transform:translateY(-50%);width:100vw;height:100%}
.lightning-svg{width:100vw;height:100%;display:block;pointer-events:none;mix-blend-mode:screen}
.orbs{position:absolute;left:0;top:0;width:100vw;height:100%;pointer-events:none;overflow:visible}
.orb{position:absolute;width:8px;height:8px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8b0, #ffd600);box-shadow:0 0 12px rgba(255,214,0,0.95),0 0 30px rgba(255,214,0,0.16);transform:translate(-50%,-50%);opacity:0;transition:opacity .18s linear}
.electric-band.active .orb{opacity:1}
.glowline{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);height:3px;width:0;background:linear-gradient(90deg, rgba(255,238,170,0), #ffd600, rgba(255,238,170,0));border-radius:8px;opacity:0}
.electric-band.active .glowline{width:100vw;opacity:1;animation:pulse 3s ease-in-out infinite}
@keyframes pulse{0%{transform:translate(-50%,-50%) scaleX(.7);opacity:.6}50%{transform:translate(-50%,-50%) scaleX(1);opacity:1}100%{transform:translate(-50%,-50%) scaleX(.7);opacity:.6}}

/* MAIN LAYOUT: center the page content */
.page-center{ max-width:1100px; margin: calc(var(--topbar-h) + var(--header-h) + 18px) auto 80px; padding:0 18px; }

/* card styles */
.card{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
#map{height:260px;border-radius:8px;overflow:hidden}

/* calc inner */
.calc{background:#fff;color:#072012;border-radius:var(--card-radius);padding:12px;margin-top:12px;box-shadow:0 10px 22px rgba(0,0,0,0.35)}
.calc h3{margin:0;color:#04462e;font-size:16px}
.small-note{font-size:12px;color:#6b7f6b;margin-top:8px}

/* top controls */
.top-controls{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:nowrap;overflow:hidden}
.top-controls label{white-space:nowrap}
.top-controls select{padding:6px;border-radius:6px;min-width:120px;max-width:420px;white-space:nowrap}
.btn-reset{margin-left:auto;padding:6px 10px;border-radius:8px;border:0;background:#e7e7e7;color:#072012;cursor:pointer;font-weight:600}

/* table items */
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table td{padding:8px;border-top:1px solid rgba(0,0,0,0.06);vertical-align:middle;font-size:14px;color:#072012}
.icon{width:60px;text-align:center}
.icon .circle{width:38px;height:38px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#072012}
.qty{width:80px;text-align:center}
.usage{width:170px}
.cons-title{font-weight:700;color:#04462e;margin-bottom:4px}
.item-meta{font-size:12px;color:#6b7f6b;margin-top:2px}
.item-meta .meta-qty{margin-right:12px}

/* results */
.results{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.result-card{background:rgba(0,0,0,0.03);padding:12px;border-radius:8px;flex:1;text-align:center;min-width:170px}
.result-card .label{font-size:13px;color:#6b7f6b}
.result-card .value{font-weight:800;font-size:18px;color:#04462e;margin-top:6px}
.result-card#bimCard{ background: var(--bim-bg); border:2px solid rgba(179,116,0,0.14); box-shadow:0 6px 18px rgba(179,116,0,0.08); }
.result-card#bimCard .value{ color: var(--bim-text); font-size:20px; }

/* footer */
.footer{margin-top:20px;padding:24px 0;text-align:center;color:#fff}
.footer .brand{font-weight:800;display:block;margin-bottom:6px}
.footer .small{font-size:13px;opacity:0.95}

/* responsive: burger visible on small screens only */
@media(max-width:1100px){
  nav{display:none}
  .burger{display:flex}
  .page-center{ margin-top: calc(var(--topbar-h) + var(--header-h) + 8px); padding: 0 12px; }
}
@media(max-width:700px){
  #map{height:200px}
  .icon .circle{width:30px;height:30px}
  .top-controls{flex-wrap:wrap}
}
</style>
</head>
<body>

<!-- topbar/header -->
<div class="topbar">
  <div class="left"><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Abidjan, C√¥te d‚ÄôIvoire</div>
  <div class="right"><i class="fas fa-phone" aria-hidden="true"></i> +225 07 07 07 07 07</div>
</div>

<header>
  <div class="logo-text">
    <a href="#"><img src="green bridge domo.png" alt="logo"></a>
    <div class="company-name">GREENBRIDGE</div>
  </div>

  <!-- burger (mobile only via media query) -->
  <button class="burger" id="burgerBtn" aria-label="Ouvrir le menu mobile" aria-expanded="false" aria-controls="mobileNav">
    <span class="icon"><span></span><span></span><span></span></span>
  </button>

  <nav aria-label="Menu principal">
    <a href="#" class="active">Accueil</a>
    <div class="dropdown" aria-haspopup="true" aria-expanded="false">
      <a href="#" data-current="‚ö° Panneaux solaires" id="energieLink">√ânergie<span class="sub-badge">‚ö° Panneaux solaires</span></a>
      <ul class="dropdown-content" role="menu" aria-label="Sous-menu √©nergie">
        <li><a href="#" class="active-item" aria-current="page">‚ö° Panneaux solaires</a></li>
        <li><a href="#">üîã Batteries & stockage</a></li>
        <li><a href="#">üîå Onduleurs</a></li>
        <li><a href="#">‚öôÔ∏è Groupes √©lectrog√®nes</a></li>
      </ul>
    </div>
    <a href="#">Domotique</a>
    <a href="#">S√©curit√©</a>
    <a href="#">Maintenance</a>
  </nav>
</header>

<!-- mobile nav -->
<div class="mobile-nav" id="mobileNav" aria-hidden="true">
  <div class="inner">
    <a href="#" class="mobile-link">Accueil</a>

    <div>
      <a href="#" id="mobileEnergieToggle" class="mobile-link active" data-current="‚ö° Panneaux solaires" aria-expanded="true">
        √ânergie
        <span class="caret" aria-hidden="true"><i class="fas fa-chevron-down" style="margin-left:6px"></i></span>
      </a>
      <div class="submenu" id="mobileEnergieSub" style="display:flex;flex-direction:column;">
        <a href="#" class="active-item" aria-current="page">‚ö° Panneaux solaires</a>
        <a href="#">üîã Batteries & stockage</a>
        <a href="#">üîå Onduleurs</a>
        <a href="#">‚öôÔ∏è Groupes √©lectrog√®nes</a>
      </div>
    </div>

    <a href="#" class="mobile-link">Domotique</a>
    <a href="#" class="mobile-link">S√©curit√©</a>
    <a href="#" class="mobile-link">Maintenance</a>

    <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:10px;display:flex;gap:12px;align-items:center;">
      <a href="#" aria-label="Facebook"><i class="fab fa-facebook" aria-hidden="true"></i></a>
      <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin" aria-hidden="true"></i></a>
      <a href="#" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
    </div>
  </div>
</div>

<!-- electric band -->
<div class="electric-band" id="energyBand" aria-hidden="true">
  <div class="container">
    <svg class="lightning-svg" viewBox="0 0 2000 40" preserveAspectRatio="none">
      <path class="zap" d="M10,22 C260,6 520,36 840,20 C1120,8 1440,34 1760,18 C1880,6 1960,28 1990,22" stroke-opacity="0.14"/>
      <path class="zap" d="M10,24 C280,36 600,6 860,22 C1140,36 1460,6 1800,22 C1880,36 1960,10 1990,22" stroke-opacity="0.10"/>
      <path class="bright" id="zapBright" d="M20,22 C300,6 600,34 880,16 C1240,0 1520,32 1860,14 C1960,2 1980,30 1990,22" stroke-opacity="1" stroke-dasharray="520" stroke-dashoffset="520"/>
    </svg>
    <div class="orbs">
      <div class="orb" id="eOrbA"></div>
      <div class="orb" id="eOrbB"></div>
      <div class="orb" id="eOrbC"></div>
    </div>
    <div class="glowline" id="eGlowline"></div>
  </div>
</div>

<!-- CENTERED PAGE WRAPPER -->
<div class="page-center" role="main" aria-label="Calculateur principal">

  <!-- hero -->
  <div class="card" style="margin-bottom:12px; text-align:center;">
    <h2 style="margin:6px 0;color:#04462e">Panneaux Solaires & Calculateur simplifi√©</h2>
    <p style="margin:0;color:#3d5b3f">Estimation indicative ‚Äî pour une √©tude pr√©cise, contactez notre Bureau d'√âtude GreenBridge.</p>
  </div>

  <div class="card" id="mapCard">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong style="color:#072012">Nos zones d'intervention</strong>
      <small style="color:#666">Abidjan ‚Ä¢ Yamoussoukro ‚Ä¢ Dakar</small>
    </div>
    <div id="map" style="margin-top:10px"></div>

    <!-- Calculator directly under map -->
    <div class="calc" id="calcCard">
      <h3>Calculateur rapide ‚Äî Consommation</h3>
      <div class="small-note">Saisissez uniquement les quantit√©s et le mode d'utilisation (taille/marque quand demand√©). Hypoth√®ses internes ‚Äî r√©sultats indicatifs.</div>

      <!-- controls -->
      <div class="top-controls" style="margin-top:10px;">
        <label style="font-size:13px;color:#072012">Zone :</label>
        <select id="zone" aria-label="Zone">
          <option value="ci">C√¥te d'Ivoire (Abidjan / Yamoussoukro)</option>
          <option value="sn">S√©n√©gal (Dakar)</option>
        </select>

        <label style="font-size:13px;color:#072012">Ville :</label>
        <select id="city" aria-label="Ville"></select>

        <label style="font-size:13px;color:#072012">Type tarifaire :</label>
        <select id="tarif" style="min-width:260px" aria-label="Type tarifaire"></select>

        <button id="resetBtn" class="btn-reset" title="R√©initialiser toutes les valeurs">R√©initialiser</button>
      </div>

      <!-- items table -->
      <table class="table" aria-hidden="false">
        <tbody id="itemsBody"></tbody>
      </table>

      <!-- autres -->
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input type="checkbox" id="enableAutres"><label for="enableAutres" style="color:#072012">Saisir "Autres (Grande puissance)"</label>
      </div>
      <div id="autresPanel" style="display:none;margin-top:8px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label style="font-size:13px;color:#072012">Qt√©</label><input id="autresQty" class="qty" type="number" value="0" min="0" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <label style="font-size:13px;color:#072012">Puissance (W)</label><input id="autresPower" class="qty" type="number" value="0" style="width:100px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <label style="font-size:13px;color:#072012">Heures/j</label><input id="autresH" class="qty" type="number" value="0" step="0.1" style="width:90px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
        </div>
      </div>

      <!-- results -->
      <div class="results">
        <div class="result-card">
          <div class="label">Consommation (kWh / mois)</div>
          <div id="consMonth" class="value">0 kWh</div>
        </div>
        <div class="result-card">
          <div class="label">Montant (mensuel)</div>
          <div id="montantMens" class="value">0 FCFA</div>
        </div>
        <div class="result-card" id="bimCard">
          <div class="label">Montant (bimensuel)</div>
          <div id="montantBi" class="value">0 FCFA</div>
        </div>
        <div class="result-card">
          <div class="label">Montant (hebdo)</div>
          <div id="montantHebdo" class="value">0 FCFA</div>
        </div>
      </div>

      <div class="small-note" style="margin-top:8px">Note : Les puissances & heures sont des hypoth√®ses internes du Bureau d'√©tude GreenBridge. R√©sultats indicatifs ‚Äî contactez-nous pour une √©tude d√©taill√©e.</div>
    </div>
  </div>

</div> <!-- /.page-center -->

<footer class="footer" style="text-align:center;color:#fff;padding:28px 5vw 36px;">
  <div class="brand">GREENBRIDGE</div>
  <div class="small">¬© 2025 GreenBridge √ânergie ‚Äî Abidjan, C√¥te d‚ÄôIvoire ‚Äî Tel: +225 07 07 07 07 07.</div>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===== MAP & CITY COORDS ===== */
let map = null;
const CITY_COORDS = {
  'ci_all': { bounds: [[5.345317,-4.024429],[6.818351,-5.276987]] , center:[6.05,-4.65], zoom:7 },
  'ci_abidjan': {lat:5.345317, lng:-4.024429, zoom:12},
  'ci_yamoussoukro': {lat:6.818351, lng:-5.276987, zoom:11},
  'sn_all': { center:[14.0,-14.0], zoom:6 },
  'sn_dakar': {lat:14.6937, lng:-17.44406, zoom:12}
};

function initMap(){
  try {
    map = L.map('map', { dragging:true, zoomControl:true, attributionControl:false }).setView([6.5, -5.0], 6.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
    const pin = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[22,22], iconAnchor:[11,22] });
    L.marker([5.345317,-4.024429],{icon:pin}).addTo(map).bindTooltip('Abidjan');
    L.marker([6.818351,-5.276987],{icon:pin}).addTo(map).bindTooltip('Yamoussoukro');
    L.marker([14.6937,-17.44406],{icon:pin}).addTo(map).bindTooltip('Dakar');
    map.fitBounds([[5.345317,-4.024429],[6.818351,-5.276987]], { padding:[20,20] });
  } catch(e){ console.warn(e) }
}
function zoomToCity(key){
  if(!map) return;
  const info = CITY_COORDS[key];
  if(!info) return;
  if(info.bounds){
    if(info.center) map.setView(info.center, info.zoom || 7);
    else map.fitBounds(info.bounds, {padding:[20,20]});
  } else if(info.lat && info.lng){
    map.setView([info.lat, info.lng], info.zoom || 10);
  } else if(info.center){
    map.setView(info.center, info.zoom || 7);
  }
}

/* ===== electric band orbs ===== */
(function(){
  const band = document.getElementById('energyBand'); if(!band) return;
  const a = document.getElementById('eOrbA'), b = document.getElementById('eOrbB'), c = document.getElementById('eOrbC');
  [a,b,c].forEach((o,i)=>{ if(o){ o.classList.add('buzz'); o.style.animationDelay=(i*120)+'ms'; o.style.opacity='1'; }});
  let t0 = performance.now();
  const params = [{r:0.5,ry:8,s:0.06,p:0},{r:0.33,ry:6,s:0.08,p:Math.PI/2},{r:0.42,ry:10,s:0.05,p:Math.PI}];
  function tick(now){
    const time=(now-t0)/1000; const cont = band.querySelector('.container'); if(!cont){ requestAnimationFrame(tick); return; }
    const rect = cont.getBoundingClientRect(); const cx = rect.width/2; const cy = rect.height/2;
    [a,b,c].forEach((o,i)=>{ if(!o) return; const p=params[i]; const rx = Math.max(Math.min(rect.width * p.r, 4000), 120); const ang = (time * p.s * Math.PI * 2) + p.p; const x = cx + Math.cos(ang) * rx; const y = cy + Math.sin(ang) * p.ry; o.style.left = x + 'px'; o.style.top = y + 'px'; o.style.transform='translate(-50%,-50%)'; });
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
  band.classList.add('active');
})();

/* ===== ITEMS (defaults = 0; usages default to "Tous les jours") ===== */
const items = [
  { id:'eclairage', label:'√âclairage ‚Ä¢ LED/Fluo', icon:'fa-lightbulb', color:'#ffd54f', qty:0, usage:'Tous les jours', variantType:'none', powerW:20, hours:4 },
  { id:'ventilation', label:'Ventilation', icon:'fa-fan', color:'#90caf9', qty:0, usage:'Tous les jours', variantType:'size', sizes:{'Petit':50,'Moyen':75,'Grand':100}, selectedSize:'Moyen', hours:8 },
  { id:'vent_plafond', label:'Ventilateur Plafond', icon:'fa-fan', color:'#80deea', qty:0, usage:'Tous les jours', variantType:'size', sizes:{'Plafond':120}, selectedSize:'Plafond', hours:3 },
  { id:'clim', label:'Climatisation ‚Ä¢ Climatiseur', icon:'fa-snowflake', color:'#b39ddb', qty:0, usage:'Tous les jours', variantType:'brand', brands:{'Nasco':1120,'TCL':1133,'Samsung':1000,'Smart':1120}, selectedBrand:'Nasco', hours:8 },
  { id:'phone', label:'T√©l√©phone portable', icon:'fa-mobile-screen', color:'#a5d6a7', qty:0, usage:'Tous les jours', variantType:'none', powerW:30, hours:2 },
  { id:'tablet', label:'Tablette', icon:'fa-tablet-screen', color:'#c5e1a5', qty:0, usage:'Tous les jours', variantType:'none', powerW:65, hours:1 },
  { id:'pcp', label:'PC portable', icon:'fa-laptop', color:'#ffe082', qty:0, usage:'Tous les jours', variantType:'none', powerW:85, hours:1 },
  { id:'pcb', label:'PC Bureau', icon:'fa-desktop', color:'#ffd3b6', qty:0, usage:'Tous les jours', variantType:'none', powerW:170, hours:0.25 },
  { id:'tv', label:'TV ‚Ä¢ √âcran plat', icon:'fa-tv', color:'#ffab91', qty:0, usage:'Tous les jours', variantType:'none', powerW:150, hours:4 },
  { id:'decodeur', label:'D√©codeur DSL/ADSL', icon:'fa-wifi', color:'#ce93d8', qty:0, usage:'Tous les jours', variantType:'none', powerW:45, hours:24 },
  { id:'frigo', label:'R√©frig√©rateur', icon:'fa-box-archive', color:'#a7ffeb', qty:0, usage:'Tous les jours', variantType:'size', sizes:{'Petit':125,'Moyen':150,'Grand':175}, selectedSize:'Grand', hours:24 },
  { id:'congel', label:'Cong√©lateur', icon:'fa-snowflake', color:'#b2ebf2', qty:0, usage:'Tous les jours', variantType:'size', sizes:{'Petit':175,'Moyen':195,'Grand':225}, selectedSize:'Grand', hours:24 },
  { id:'seche', label:'S√®che Cheveux', icon:'fa-wind', color:'#ffcc80', qty:0, usage:'Tous les jours', variantType:'none', powerW:2000, hours:0.25 },
  { id:'micro', label:'Micro-Onde', icon:'fa-burn', color:'#ffd180', qty:0, usage:'Tous les jours', variantType:'none', powerW:900, hours:0.25 },
  { id:'cafe', label:'Cafeti√®re / Bouilloire', icon:'fa-mug-hot', color:'#ffecb3', qty:0, usage:'Tous les jours', variantType:'none', powerW:1500, hours:0.05 },
  { id:'robot', label:'Robot / Mixeur', icon:'fa-blender', color:'#c8e6c9', qty:0, usage:'Tous les jours', variantType:'none', powerW:500, hours:0.05 },
  { id:'autres', label:'Autres (Grande puissance)', icon:'fa-bolt', color:'#ffd1dc', qty:0, usage:'Tous les jours', variantType:'custom', powerW:0, hours:0 }
];
const usageFactors = {'Tous les jours':1,'R√©gulier':0.6,'Occasionnel':0.2,'Rare':0.05};

/* ===== TARIFFS (CI & SN) ===== */
const CI_TARIFFS = {
  'social_5A': { label: "Tarif Domestique Social ‚Äî monophas√© 5A (post-paiement)", prime_bi: 614.90, tranche_limit_kwh_bi: 80, price_ht: [31.72, 55.18], redevance_rurale_per_kwh: 1.00, taxe_ordures_per_kwh_abj: 2.50, taxe_ordures_per_kwh_other: 1.00, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.00 },
  'dom_gen_5A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 5A (post-paiement)", prime_bi: 1371.22, price_ht: [73.66, 63.84], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'dom_gen_10A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 10A (post-paiement)", prime_bi: 1371.22, price_ht: [73.66, 63.84], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'dom_gen_15A': { label: "Tarif Domestique G√©n√©ral ‚Äî monophas√© 15A (post-paiement)", prime_bi: 1508.34, price_ht: [81.03, 70.22], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 },
  'triphase': { label: "Tarif Domestique G√©n√©ral ‚Äî triphas√© (post-paiement)", prime_bi: 1508.34, price_ht: [81.03, 70.22], redevance_rurale_per_kwh: 1.06, redevance_electrif_bi: 100, redevance_rti_per_kwh: 2.00, rti_cap_bi: 2000, TVA: 0.18 }
};
const SN_TARIFFS = {
  'SN_UD_DPP': { label:'Usage Domestique ‚Äî Petite Puissance (DPP)', prices:[91.17,136.49,159.36], tr:[150,200], prime_mois:0 },
  'SN_UD_DMP': { label:'Usage Domestique ‚Äî Moyenne Puissance (DMP)', prices:[111.23,143.54,158.46], tr:[50,300], prime_mois:0 },
  'SN_PREPAY_DPP': { label:'Pr√©pay√© ‚Äî Domestique Petite Puissance (DPP)', prices:[91.17,136.49,149.06], tr:[150,200], prime_mois:0 },
  'SN_UP_PPP': { label:'Usage Professionnel ‚Äî Petite Puissance (PPP)', prices:[163.81,189.84,198.68], tr:[50,500], prime_mois:0 }
};

/* ===== DOM refs ===== */
const itemsBody = document.getElementById('itemsBody');
const tarifSelect = document.getElementById('tarif');
const zoneSelect = document.getElementById('zone');
const citySelect = document.getElementById('city');
const consMonthEl = document.getElementById('consMonth');
const montantMensEl = document.getElementById('montantMens');
const montantBiEl = document.getElementById('montantBi');
const montantHebdoEl = document.getElementById('montantHebdo');
const enableAutres = document.getElementById('enableAutres');
const autresPanel = document.getElementById('autresPanel');
const autresQty = document.getElementById('autresQty');
const autresPower = document.getElementById('autresPower');
const autresH = document.getElementById('autresH');
const resetBtn = document.getElementById('resetBtn');

const PUISSANCE_SOUSCRITE_DEFAULT_KW = 1;

/* Render items */
function renderItems(){
  itemsBody.innerHTML = '';
  items.forEach((it, idx) => {
    if(it.id === 'autres') return;
    const tr = document.createElement('tr');
    let variantHtml = '';
    if(it.variantType === 'size' && it.sizes){
      variantHtml = '<div style="margin-top:6px"><select data-idx="'+idx+'" class="variant-select" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">';
      Object.keys(it.sizes).forEach(sz => {
        const sel = (it.selectedSize === sz) ? 'selected' : '';
        variantHtml += `<option value="${sz}" ${sel}>${sz}</option>`;
      });
      variantHtml += '</select></div>';
    } else if(it.variantType === 'brand' && it.brands){
      variantHtml = '<div style="margin-top:6px"><select data-idx="'+idx+'" class="variant-brand" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">';
      Object.keys(it.brands).forEach(b => {
        const sel = (it.selectedBrand === b) ? 'selected' : '';
        variantHtml += `<option value="${b}" ${sel}>${b}</option>`;
      });
      variantHtml += '</select></div>';
    }

    tr.innerHTML = `
      <td class="icon"><span class="circle" style="background:${it.color}"><i class="fa ${it.icon}"></i></span></td>
      <td style="width:48%">
        <div class="cons-title">${it.label}</div>
        <div class="item-meta">
          <span class="meta-qty" data-idx="${idx}">nombres de consommateurs : ${it.qty}</span>
          <span class="meta-usage" data-idx="${idx}">Fr√©quence : ${it.usage}</span>
        </div>
        ${variantHtml?variantHtml:''}
      </td>
      <td class="qty"><input data-idx="${idx}" class="qty-input" type="number" min="0" value="${it.qty}" style="width:70px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"></td>
      <td class="usage">
        <select data-idx="${idx}" class="usage-select" style="padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">
          <option ${it.usage==='Tous les jours'?'selected':''}>Tous les jours</option>
          <option ${it.usage==='R√©gulier'?'selected':''}>R√©gulier</option>
          <option ${it.usage==='Occasionnel'?'selected':''}>Occasionnel</option>
          <option ${it.usage==='Rare'?'selected':''}>Rare</option>
        </select>
      </td>
    `;
    itemsBody.appendChild(tr);
  });

  // events
  document.querySelectorAll('.qty-input').forEach(inp=>{
    inp.addEventListener('input', e => {
      const i = +e.target.dataset.idx;
      items[i].qty = Math.max(0, Number(e.target.value||0));
      const metaQtySpan = document.querySelector('.meta-qty[data-idx="'+i+'"]');
      if(metaQtySpan) metaQtySpan.textContent = 'nombres de consommateurs : ' + items[i].qty;
      recalc();
    });
  });
  document.querySelectorAll('.usage-select').forEach(sel=>{
    sel.addEventListener('change', e => {
      const i = +e.target.dataset.idx; items[i].usage = e.target.value;
      const metaUsageSpan = document.querySelector('.meta-usage[data-idx="'+i+'"]');
      if(metaUsageSpan) metaUsageSpan.textContent = 'Fr√©quence : ' + items[i].usage;
      recalc();
    });
  });
  document.querySelectorAll('.variant-select').forEach(sel=>{
    sel.addEventListener('change', e => { const i = +e.target.dataset.idx; items[i].selectedSize = e.target.value; recalc(); });
  });
  document.querySelectorAll('.variant-brand').forEach(sel=>{
    sel.addEventListener('change', e => { const i = +e.target.dataset.idx; items[i].selectedBrand = e.target.value; recalc(); });
  });
}

/* Populate tarifs & cities */
function populateTarifs(zone){
  tarifSelect.innerHTML = '';
  citySelect.innerHTML = '';

  if(zone === 'ci'){
    const cAll = document.createElement('option'); cAll.value='ci_all'; cAll.textContent = 'C√¥te d\'Ivoire (toutes villes)'; citySelect.appendChild(cAll);
    const cab = document.createElement('option'); cab.value='ci_abidjan'; cab.textContent = 'Abidjan'; citySelect.appendChild(cab);
    const y = document.createElement('option'); y.value='ci_yamoussoukro'; y.textContent = 'Yamoussoukro'; citySelect.appendChild(y);

    Object.keys(CI_TARIFFS).forEach(k=>{
      const o = document.createElement('option'); o.value = 'ci|'+k; o.textContent = CI_TARIFFS[k].label; tarifSelect.appendChild(o);
    });
    citySelect.value = 'ci_abidjan';
  } else {
    const sAll = document.createElement('option'); sAll.value='sn_all'; sAll.textContent = 'S√©n√©gal (toutes villes)'; citySelect.appendChild(sAll);
    const d = document.createElement('option'); d.value='sn_dakar'; d.textContent = 'Dakar'; citySelect.appendChild(d);

    Object.keys(SN_TARIFFS).forEach(k=>{
      const o = document.createElement('option'); o.value = 'sn|'+k; o.textContent = SN_TARIFFS[k].label; tarifSelect.appendChild(o);
    });
    citySelect.value = 'sn_dakar';
  }

  zoomToCity(citySelect.value);
  recalc();
}

/* formatting */
function fmt(n,dec=2){ return Number(n||0).toFixed(dec).replace(/\B(?=(\d{3})+(?!\d))/g,' '); }
function fcfa(n){ return Number(Math.round(n||0)).toLocaleString('fr-FR') + ' FCFA' }

/* Billing functions (CI and SN) */
function computeCIBill(consumption_kwh_bi, tariffKey, opts = {}) {
  const t = CI_TARIFFS[tariffKey];
  if(!t) throw new Error('Tarif CI introuvable: ' + tariffKey);
  const puissanceSouscrite = Number(opts.puissanceSouscrite_kW || PUISSANCE_SOUSCRITE_DEFAULT_KW);
  let limit = t.tranche_limit_kwh_bi;
  if(!limit && tariffKey.startsWith('dom_gen')) limit = 180 * puissanceSouscrite;

  let rem = consumption_kwh_bi; let energy_ht_bi = 0;
  if(Array.isArray(t.price_ht) && limit !== undefined){
    const p1 = t.price_ht[0], p2 = t.price_ht[1];
    const inT1 = Math.min(rem, limit); energy_ht_bi += inT1 * p1; rem -= inT1;
    if(rem>0) energy_ht_bi += rem * p2;
  } else {
    const p = Array.isArray(t.price_ht)?t.price_ht[0]:95; energy_ht_bi = consumption_kwh_bi * p;
  }

  const TVA = (typeof t.TVA === 'number') ? t.TVA : 0.18;
  const tva_bi = energy_ht_bi * TVA;
  const prime_bi = Number(t.prime_bi || 0);
  const redevance_rurale = (t.redevance_rurale_per_kwh || 0) * consumption_kwh_bi;
  const taxe_ordures = (opts.isAbidjan ? (t.taxe_ordures_per_kwh_abj || 0) : (t.taxe_ordures_per_kwh_other || 0)) * consumption_kwh_bi;
  const redev_elec_bi = Number(t.redevance_electrif_bi || 0);
  let rti = (t.redevance_rti_per_kwh || 0) * consumption_kwh_bi;
  if(t.rti_cap_bi) rti = Math.min(rti, t.rti_cap_bi);
  const other_taxes_bi = redevance_rurale + taxe_ordures + redev_elec_bi + rti;
  const total_bi = energy_ht_bi + tva_bi + prime_bi + other_taxes_bi;
  return { tariff: t.label, consumption_kwh_bi, energy_ht_bi, tva_bi, prime_bi, other_taxes_bi, total_bi, total_mois: total_bi/2, total_hebdo: (total_bi/2)/4, breakdown:{tranche_limit:limit, prices_ht:t.price_ht} };
}

function computeSNBill(consumption_kwh_month, tariffKey, opts = {}) {
  const t = SN_TARIFFS[tariffKey];
  if(!t) throw new Error('Tarif SN introuvable: ' + tariffKey);
  let rem = consumption_kwh_month; let energy_ht_mois = 0;
  const tr = t.tr || t.tranches || t.tr;
  if(Array.isArray(t.prices) && Array.isArray(tr) && tr.length >= 2){
    const p1=t.prices[0], p2=t.prices[1], p3=t.prices[2];
    const inT1 = Math.min(rem, tr[0]); energy_ht_mois += inT1 * p1; rem -= inT1;
    if(rem>0){ const inT2 = Math.min(rem, (tr[1] - (tr[0] || 0))); energy_ht_mois += inT2 * p2; rem -= inT2; }
    if(rem>0) energy_ht_mois += rem * p3;
  } else { const p = Array.isArray(t.prices)?t.prices[0]:150; energy_ht_mois = consumption_kwh_month * p; }
  const prime_mois = Number(t.prime_mois || 0);
  const total_mois = energy_ht_mois + prime_mois;
  return { tariff: t.label, consumption_kwh_month, energy_ht_mois, prime_mois, total_mois, total_bi: total_mois*2, total_hebdo: total_mois/4, breakdown:{prices:t.prices, tranches:tr} };
}

/* Main recalc */
function recalc(){
  let totalWhPerDay = 0;
  items.forEach(it=>{
    const qty = Number(it.qty||0);
    let power = 0, hours = Number(it.hours || 0);
    if(it.variantType === 'size' && it.sizes){ const sz = it.selectedSize || Object.keys(it.sizes)[0]; power = it.sizes[sz]; }
    else if(it.variantType === 'brand' && it.brands){ const b = it.selectedBrand || Object.keys(it.brands)[0]; power = it.brands[b]; }
    else if(it.variantType === 'custom'){ power = Number(it.powerW || 0); }
    else { power = Number(it.powerW || 0); }
    totalWhPerDay += (power * hours * qty * (usageFactors[it.usage] || 1));
  });

  if(enableAutres.checked){
    const aq = Number(autresQty.value||0), ap = Number(autresPower.value||0), ah = Number(autresH.value||0);
    totalWhPerDay += aq * ap * ah;
  }

  const pertes = 10; // %
  const totalWhPerDayEff = totalWhPerDay / (1 - pertes/100);
  const jours = 30;
  const totalKwhMonth = totalWhPerDayEff * jours / 1000;
  const totalKwhBi = totalKwhMonth * 2;

  const sel = tarifSelect.value || '';
  let montantMensuel = 0, montantBimestriel = 0, montantHebdo = 0;

  if(sel.startsWith('ci|')){
    const key = sel.split('|')[1];
    const isAbidjan = (citySelect.value === 'ci_abidjan');
    const res = computeCIBill(totalKwhBi, key, { puissanceSouscrite_kW: PUISSANCE_SOUSCRITE_DEFAULT_KW, isAbidjan });
    montantBimestriel = res.total_bi;
    montantMensuel = res.total_mois;
    montantHebdo = res.total_hebdo;
  } else if(sel.startsWith('sn|')){
    const key = sel.split('|')[1];
    const res = computeSNBill(totalKwhMonth, key, {});
    montantMensuel = res.total_mois;
    montantBimestriel = res.total_bi;
    montantHebdo = res.total_hebdo;
  } else {
    const price_ht = 95;
    const energy_ht_month = totalKwhMonth * price_ht;
    const tva = energy_ht_month * 0.18;
    montantMensuel = energy_ht_month + tva;
    montantBimestriel = montantMensuel * 2;
    montantHebdo = montantMensuel / 4;
  }

  consMonthEl.innerText = fmt(totalKwhMonth,2) + ' kWh';
  montantMensEl.innerText = fcfa(montantMensuel);
  montantBiEl.innerText = fcfa(montantBimestriel);
  montantHebdoEl.innerText = fcfa(montantHebdo);
}

/* Reset function: quotas to 0 and usage -> "Tous les jours" */
function resetAll(){
  items.forEach(it=>{
    it.qty = 0;
    it.usage = 'Tous les jours';
    if(it.variantType === 'size' && it.sizes) it.selectedSize = Object.keys(it.sizes)[0];
    if(it.variantType === 'brand' && it.brands) it.selectedBrand = Object.keys(it.brands)[0];
    if(it.variantType === 'custom'){ it.powerW = 0; it.hours = 0; }
  });
  enableAutres.checked = false;
  autresPanel.style.display = 'none';
  autresQty.value = 0; autresPower.value = 0; autresH.value = 0;
  zoneSelect.value = 'ci';
  populateTarifs(zoneSelect.value);
  renderItems();
  recalc();
}

/* Wiring */
enableAutres.addEventListener('change', ()=>{ autresPanel.style.display = enableAutres.checked ? 'block' : 'none'; recalc();});
[autresQty,autresPower,autresH].forEach(el=>el.addEventListener('input', recalc));
zoneSelect.addEventListener('change', ()=>{ populateTarifs(zoneSelect.value); });
tarifSelect.addEventListener('change', recalc);
citySelect.addEventListener('change', ()=>{ zoomToCity(citySelect.value); recalc(); });
resetBtn.addEventListener('click', resetAll);

/* MOBILE burger & nav */
(function(){
  const burger = document.getElementById('burgerBtn');
  const mobileNav = document.getElementById('mobileNav');
  if(!burger || !mobileNav) return;

  burger.addEventListener('click', ()=> {
    const opened = mobileNav.classList.toggle('open');
    burger.classList.toggle('open', opened);
    burger.setAttribute('aria-expanded', String(opened));
    mobileNav.setAttribute('aria-hidden', String(!opened));
    document.body.style.overflow = opened ? 'hidden' : '';
    const sub = document.getElementById('mobileEnergieSub');
    const toggle = document.getElementById('mobileEnergieToggle');
    if(opened && toggle && toggle.classList.contains('active')) {
      sub.style.display = 'flex';
      toggle.setAttribute('aria-expanded','true');
    }
  });

  mobileNav.addEventListener('click', function(e){
    const a = e.target.closest('a');
    if(!a) return;
    mobileNav.classList.remove('open');
    burger.classList.remove('open');
    mobileNav.setAttribute('aria-hidden','true');
    burger.setAttribute('aria-expanded','false');
    document.body.style.overflow = '';
  });

  const energieToggle = document.getElementById('mobileEnergieToggle');
  const energieSub = document.getElementById('mobileEnergieSub');
  if(energieToggle && energieSub){
    energieToggle.addEventListener('click', function(e){
      if(e.target.closest('.caret')){
        e.preventDefault(); e.stopPropagation();
        const opening = energieSub.style.display !== 'flex';
        document.querySelectorAll('.mobile-nav .submenu').forEach(s=>{ if(s!==energieSub) s.style.display='none'; });
        energieSub.style.display = opening ? 'flex' : 'none';
        energieToggle.setAttribute('aria-expanded', String(opening));
        energieToggle.classList.toggle('active', opening);
        mobileNav.classList.add('open');
        burger.classList.add('open');
        mobileNav.setAttribute('aria-hidden','false');
        burger.setAttribute('aria-expanded','true');
      } else {
        mobileNav.classList.remove('open');
        burger.classList.remove('open');
        mobileNav.setAttribute('aria-hidden','true');
        burger.setAttribute('aria-expanded','false');
        document.body.style.overflow = '';
      }
    });
  }

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape' && mobileNav.classList.contains('open')){
      mobileNav.classList.remove('open');
      burger.classList.remove('open');
      mobileNav.setAttribute('aria-hidden','true');
      burger.setAttribute('aria-expanded','false');
      document.body.style.overflow = '';
    }
  });

  function openActiveSubmenuOnSmall(){
    if(window.innerWidth <= 1100){
      const activeToggle = document.getElementById('mobileEnergieToggle');
      const activeSub = document.getElementById('mobileEnergieSub');
      if(activeToggle && activeSub){
        activeSub.style.display = 'flex';
        activeToggle.setAttribute('aria-expanded','true');
        activeToggle.classList.add('active');
      }
    } else {
      const activeSub = document.getElementById('mobileEnergieSub');
      if(activeSub) activeSub.style.display = 'none';
    }
  }
  window.addEventListener('resize', openActiveSubmenuOnSmall);
  openActiveSubmenuOnSmall();
})();

/* INIT */
function init(){ initMap(); renderItems(); populateTarifs(zoneSelect.value); recalc(); }
init();
</script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GreenBridge ‚Äî Zone agricole (pompage, solaire & PDF)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --topbar-h:48px; --header-h:72px;
  --green-dark:#061f14; --green-mid:#073217; --green-mid-2:#0b4d26;
  --accent:#7cb342; --accent-2:#a8e6a1; --bg:#0a4d2e; --muted:#e6f7ea; --gold:#d4af37; --gold-base:#d4af37;
  --card-radius:12px; --font: 'Poppins', Arial, sans-serif;
  --max-width:1100px;
  --shadow: 0 10px 22px rgba(0,0,0,0.35);

  /* ADDED: electric yellow for the energy orbs and related glow */
  --electric-yellow: #ffd600;
  --electric-yellow-soft: rgba(255,214,0,0.18);
}

/* base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--font);background:var(--bg);color:#fff}
a{color:inherit;text-decoration:none}

/* Topbar (fixed) */
.topbar{
  position:fixed;top:0;left:0;right:0;height:var(--topbar-h);
  background:var(--green-dark);
  display:flex;align-items:center;justify-content:space-between;
  gap:20px;padding:0 4vw;z-index:1800;font-size:14px;
}
.topbar .left,.topbar .right{display:flex;align-items:center;gap:12px}
.topbar a{color:#fff}

/* Header (fixed) */
header{
  position:fixed;top:var(--topbar-h);left:0;right:0;height:var(--header-h);
  background:linear-gradient(90deg,var(--green-mid),var(--green-mid-2));
  display:flex;align-items:center;justify-content:space-between;padding:0 4vw;
  z-index:1750;box-shadow:0 4px 12px rgba(0,0,0,.25)
}
.logo-text{display:flex;align-items:center;gap:12px}
.logo-text img{height:56px;display:block}
.company-name{font-size:24px;font-weight:800;color:#04462e;-webkit-text-stroke:0.8px var(--gold);padding:6px 10px;border-radius:8px}

/* Nav desktop */
nav{display:flex;gap:18px;align-items:center}
nav a{color:#fff;font-size:15px;font-weight:600;padding:8px 10px;border-radius:8px;transition:all .18s;display:flex;gap:8px;align-items:center}
nav a:hover{color:var(--accent-2)}
nav a.active{
  color:var(--accent-2);
  background: linear-gradient(90deg, rgba(212,175,55,0.06), rgba(212,175,55,0.03));
  border:1px solid rgba(212,175,55,0.22);
  padding:10px 14px;
  font-weight:800;
  border-radius:10px;
}

/* Desktop: show which subpage is active next to parent "√ânergie" (badge) */
.dropdown > a .sub-badge{
  margin-left:8px;
  padding:6px 10px;
  border-radius:10px;
  background: rgba(255,214,0,0.08);
  color: var(--electric-yellow);
  font-weight:800;
  font-size:13px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.32);
  white-space:nowrap;
  display:inline-flex;
  align-items:center;
}
@media (max-width:1100px){ .dropdown > a .sub-badge{ display:none } }

/* Dropdown caret */
.dropdown > a::after{ content:"\25BC"; font-size:12px; margin-left:6px; transition:transform .2s; opacity:1; color:var(--accent-2); }
.dropdown[aria-expanded="true"] > a::after{ transform:rotate(180deg); }

/* Dropdown */
.dropdown{position:relative}
.dropdown-content{ display:none; position:absolute; top:calc(100% + 8px); left:0; background:rgba(0,0,0,0.85); padding:8px 0; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); min-width:220px; z-index:2000;}
.dropdown-content li{list-style:none}
.dropdown-content a{display:block;padding:10px 16px;color:#fff;font-weight:600;border-radius:8px}
.dropdown-content a:hover{background:rgba(168,230,161,0.12);color:var(--accent-2);padding-left:24px}
.dropdown-content .active-item{ color: var(--accent-2); background: linear-gradient(90deg, rgba(212,175,55,0.06), rgba(212,175,55,0.03)); border: 1px solid rgba(212,175,55,0.12); padding: 10px 16px; font-weight: 800; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.28); margin: 4px 8px; }
@media (max-width:1100px){ .dropdown-content .active-item{ margin:0; border:none; box-shadow:none; background:transparent; color:inherit; padding:10px 16px; } }

/* Burger mobile - hidden on desktop (explicit) */
.burger{display:none !important;width:44px;height:44px;border-radius:8px;border:none;background:transparent;align-items:center;justify-content:center;cursor:pointer}
.burger .icon{display:block;position:relative;width:26px;height:18px}
.burger .icon span{position:absolute;left:0;right:0;height:3px;background:#fff;border-radius:2px;transition:all .25s}
.burger .icon span:nth-child(1){top:0}
.burger .icon span:nth-child(2){top:7.5px}
.burger .icon span:nth-child(3){top:15px}
.burger.open .icon span:nth-child(1){transform: translateY(7.5px) rotate(45deg)}
.burger.open .icon span:nth-child(2){opacity:0}
.burger.open .icon span:nth-child(3){transform: translateY(-7.5px) rotate(-45deg)}

.mobile-nav{display:none}

/* Mobile nav */
.mobile-nav{
  display:none;
  position:fixed;
  top:calc(var(--topbar-h) + var(--header-h));
  left:0;
  right:0;
  background:var(--bg);
  z-index:1740;
  box-shadow:0 12px 40px rgba(0,0,0,.45);
  overflow:auto;
  max-height:0;
  transition:max-height .28s ease;
}
.mobile-nav.open{ display:block; max-height:85vh; }
.mobile-nav .inner{ padding:12px 4vw; display:flex; flex-direction:column; gap:8px; align-items:stretch; }
.mobile-nav a{ padding:12px; color:#fff; width:100%; text-align:left; border-radius:8px; font-weight:700; display:flex; justify-content:space-between; align-items:center }
.mobile-nav a:hover{ background:rgba(124,179,66,0.06); color:var(--accent-2) }
.mobile-nav a.active{ background: linear-gradient(90deg, rgba(212,175,55,0.06), rgba(212,175,55,0.03)); color:var(--accent-2) }
.mobile-nav .submenu{ display:none; flex-direction:column; padding-left:12px; margin-top:6px; margin-bottom:6px; gap:6px }
.mobile-nav .submenu a{ font-weight:600; padding:8px 12px; border-radius:6px; text-align:left }
.mobile-nav .submenu a:hover{ background:rgba(168,230,161,0.08); padding-left:18px }

/* mobile: show current subpage on the Energie toggle (now includes icon if present in data-current) */
.mobile-nav .mobile-link.active[data-current]::after {
  content: attr(data-current);
  margin-left:8px;
  padding:6px 10px;
  border-radius:8px;
  background: rgba(255,214,0,0.06);
  color: var(--electric-yellow);
  font-weight:800;
  font-size:13px;
  white-space:nowrap;
}

/* disabled look for active submenu item on mobile */
.mobile-nav a.mobile-disabled { pointer-events: none; cursor: default; opacity: 0.9; color: rgba(255,255,255,0.65) !important; }
.mobile-nav .submenu a.mobile-disabled { color: rgba(255,255,255,0.65) !important; opacity: 0.95; padding-left:12px; background: transparent; box-shadow: none; font-weight:700; }

/* --- electric band --- */
.electric-band {
  position: fixed;
  top: calc(var(--topbar-h) + var(--header-h) - 6px);
  left: 0;
  right: 0;
  height: 14px;
  z-index: 1900;
  pointer-events: none;
  overflow: visible;
  transform: translateZ(0);
}
.electric-band .container { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 100vw; max-width: none; padding:0; height:100%; pointer-events:none; box-sizing:border-box; }
.lightning-svg { width:100vw; height:100%; display:block; pointer-events:none; mix-blend-mode: screen; }
.lightning-svg path.zap { stroke: var(--electric-yellow); stroke-width:2.0; fill:none; stroke-linecap:round; stroke-linejoin:round; opacity:0.9; }
.lightning-svg path.bright { stroke: var(--electric-yellow); stroke-width:2.6; fill:none; stroke-linecap:round; stroke-linejoin:round; opacity:1; stroke-dasharray:520; stroke-dashoffset:520; }

.orbs{position:absolute;left:0;top:0;width:100vw;height:100%;pointer-events:none;overflow:visible}
.orb{position:absolute;width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8b0, var(--electric-yellow));box-shadow:0 0 12px rgba(255,214,0,0.95), 0 0 30px rgba(255,214,0,0.16);transform:translate(-50%,-50%);opacity:0;transition:opacity .18s linear}
.electric-band.active .orb{opacity:1}
@keyframes buzz-slow { 0%{ transform: translate(-50%,-50%) translateX(-1.6px) } 50%{ transform: translate(-50%,-50%) translateX(1.6px) } 100%{ transform: translate(-50%,-50%) translateX(-1.6px) } }
.orb.buzz{ animation: buzz-slow 1.8s linear infinite; }

.glowline{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); height:3px; width:0; background: linear-gradient(90deg, rgba(255,238,170,0), var(--electric-yellow), rgba(255,238,170,0)); border-radius:8px; box-shadow:0 6px 18px rgba(255,214,0,0.12); opacity:0; transition:opacity .22s ease; }
.electric-band.active .glowline{ width:100vw; opacity:1; animation:pulse 3s ease-in-out infinite }
@keyframes pulse{ 0%{ transform:translate(-50%,-50%) scaleX(.7); opacity:.6 } 50%{ transform:translate(-50%,-50%) scaleX(1); opacity:1 } 100%{ transform:translate(-50%,-50%) scaleX(.7); opacity:.6 } }

/* page center wrapper + cards + form styles (kept from original) */
.page-center{ max-width:var(--max-width); margin: calc(var(--topbar-h) + var(--header-h) + 18px) auto 80px; padding:0 18px; }
.card{background:#fff;color:#072012;border-radius:var(--card-radius);padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
h1{margin:0;color:#04462e;font-size:20px}
.muted{color:#6b7f6b;font-size:13px}

/* ... other original styles kept (grid/fields/results/summary/map) */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width:700px){ .grid{grid-template-columns:1fr} }

.field{display:flex;flex-direction:column;gap:6px}
label{font-size:13px;color:#072012}
input[type="number"],input[type="text"],select{padding:8px;border-radius:6px;border:1px solid #e6e6e6}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}

.btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#072012;font-weight:700;cursor:pointer}
.btn-ghost{background:#f3f3f3;border:1px solid #e6e6e6;color:#072012;padding:8px 10px;border-radius:8px}

.suggests{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.suggest{background:linear-gradient(180deg,#f3fff8,#ecfff5);padding:8px;border-radius:10px;border:1px solid #e0f3e9;color:#072012;cursor:pointer;font-weight:600}

.consumer-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.consumer{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;color:#072012}
.consumer .meta{font-size:13px;color:#6b7f6b}

.results{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
@media (max-width:1000px){ .results{grid-template-columns:repeat(2,1fr)} }
@media (max-width:700px){ .results{grid-template-columns:1fr} }

.result-card{
  background:linear-gradient(180deg,#fbfffb,#f3fff2);
  padding:14px;border-radius:12px;min-width:170px;border:1px solid rgba(3,50,26,0.06);
  box-shadow:0 14px 36px rgba(2,22,12,0.12);
  color:#072012;
}
.result-card .label{font-size:13px;color:#6b7f6b;text-transform:uppercase;letter-spacing:0.6px}
.result-card .value{font-weight:900;font-size:20px;color:var(--green-mid-2);margin-top:6px;display:block}
.result-card .small{font-size:13px;color:#6b7f6b;margin-top:6px}

/* emphasize panels & battery */
#r_panels .value, #r_batt .value { color:#04462e; font-size:24px; background:linear-gradient(90deg, rgba(124,179,66,0.08), rgba(181,134,0,0.04)); padding:6px 10px;border-radius:999px; box-shadow:0 8px 20px rgba(124,179,66,0.06); }

/* summary */
.summary{display:flex;gap:12px;margin-top:18px;align-items:stretch;flex-wrap:wrap}
.summary .big{ flex:1;padding:16px;border-radius:14px;background:#fff;border:1px solid #e6f3ea;color:#072012;box-shadow:var(--shadow) }
.big h2{margin:0;color:#04462e}
.big .kpi{display:flex;gap:12px;align-items:center;margin-top:12px}
.kpi .num{font-weight:900;font-size:22px;color:#0b4d26}
.kpi .muted{font-size:13px;color:#6b7f6b}

/* map */
#mapCard{padding:0;overflow:hidden}
#map{height:260px;border-radius:8px}

/* PDF button */
.pdf-btn{background:#d9534f;color:#fff;padding:8px 12px;border-radius:8px;border:0;font-weight:700;cursor:pointer}

/* small */
.note{font-size:12px;color:#6b7f6b;margin-top:10px}

/* highlight */
.highlight{border:2px solid var(--accent);box-shadow:0 8px 30px rgba(124,179,66,0.12);}

input:focus,select:focus,button:focus{outline:none;box-shadow:0 0 0 4px rgba(124,179,66,0.12)}

/* Footer (matching other pages: gold line on top, dark bg, styled company block) */
footer{
  background:var(--green-dark);
  color:#fff;
  padding:28px 5vw 36px;
  position:relative;
  margin-top:40px;
  text-align:center;
  box-shadow: 0 -6px 12px rgba(0,0,0,0.35);
}
footer::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:2px;
  background:var(--gold-base);
}
.footer-company{
  display:block;
  margin:0 auto 8px;
  font-size:18px;
  font-weight:800;
  color:#04462e;
  -webkit-text-stroke:0.7px var(--gold);
  text-shadow:0 3px 6px rgba(0,0,0,0.6);
  padding:4px 8px;
  border-radius:6px;
  width:max-content;
  background: linear-gradient(90deg, rgba(212,175,55,0.02), rgba(255,255,255,0) 40%);
}
.footer-contact{margin-top:6px;color:#e6f7ea;line-height:1.6;text-align:center}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar" role="banner">
  <div class="left"><a href="#" aria-label="Localisation"><i class="fas fa-map-marker-alt" aria-hidden="true"></i>&nbsp; Abidjan, C√¥te d‚ÄôIvoire</a></div>
  <div class="right"><a href="tel:+22507070707"><i class="fas fa-phone" aria-hidden="true"></i>&nbsp;+225 07 07 07 07 07</a></div>
</div>

<!-- Header -->
<header role="navigation" aria-label="Main">
  <div style="display:flex;align-items:center;gap:12px;padding-left:18px">
    <div class="logo-text">
      <a href="Code1.html"><img src="green bridge domo.png" alt="logo"></a>
      <div class="company-name">GREENBRIDGE</div>
    </div>
  </div>

  <!-- hamburger (mobile only via media query) -->
  <button class="burger" id="burgerBtn" aria-label="Ouvrir le menu mobile" aria-expanded="false" aria-controls="mobileNav">
    <span class="icon"><span></span><span></span><span></span></span>
  </button>

  <nav aria-label="Menu principal">
    <a href="Code1.html">Accueil</a>

    <div class="dropdown" aria-haspopup="true" aria-expanded="false">
      <a href="energie.html" id="energieLink" data-current="üåæ Zone agricole">
        √ânergie
        <span class="sub-badge">üåæ Zone agricole</span>
      </a>
      <ul class="dropdown-content" role="menu" aria-label="Sous-menu √©nergie" id="dropdownContent">
        <li><a href="zone_urbaine.html" role="menuitem">üèôÔ∏è Zone Urbaine</a></li>
        <li><a href="zone_agricole.html" role="menuitem" class="active-item" aria-current="page">üåæ Zone agricole</a></li>
        <li><a href="panneaux.html" role="menuitem">‚ö° Panneaux solaires</a></li>
        <li><a href="batteries.html" role="menuitem">üîã Batteries & stockage</a></li>
        <li><a href="onduleurs.html" role="menuitem">üîå Onduleurs</a></li>
        <li><a href="groupes.html" role="menuitem">‚öôÔ∏è Groupes √©lectrog√®nes</a></li>
      </ul>
    </div>

    <a href="domotique.html">Domotique</a>
    <a href="securite.html">S√©curit√©</a>
    <a href="maintenance.html">Maintenance</a>
  </nav>
</header>

<!-- mobile nav -->
<div class="mobile-nav" id="mobileNav" aria-hidden="true">
  <div class="inner">
    <a href="Code1.html" class="mobile-link">Accueil</a>

    <div>
      <a href="energie.html" id="mobileEnergieToggle" class="mobile-link active" data-current="üåæ Zone agricole" aria-expanded="true">
        √ânergie
        <span class="caret" aria-hidden="true"><i class="fas fa-chevron-down" style="margin-left:6px"></i></span>
      </a>
      <div class="submenu" id="mobileEnergieSub" style="display:flex;flex-direction:column;">
        <a href="zone_urbaine.html">üèôÔ∏è Zone Urbaine</a>
        <a href="zone_agricole.html" class="active-item" aria-current="page">üåæ Zone agricole</a>
        <a href="panneaux.html">‚ö° Panneaux solaires</a>
        <a href="batteries.html">üîã Batteries & stockage</a>
        <a href="onduleurs.html">üîå Onduleurs</a>
        <a href="groupes.html">‚öôÔ∏è Groupes √©lectrog√®nes</a>
      </div>
    </div>

    <a href="domotique.html" class="mobile-link">Domotique</a>
    <a href="securite.html" class="mobile-link">S√©curit√©</a>
    <a href="maintenance.html" class="mobile-link">Maintenance</a>

    <div style="margin-top:8px;border-top:1px solid rgba(255,255,255,0.03);padding-top:10px;display:flex;gap:12px;align-items:center;">
      <a href="#" aria-label="Facebook"><i class="fab fa-facebook" aria-hidden="true"></i></a>
      <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin" aria-hidden="true"></i></a>
      <a href="#" aria-label="Instagram"><i class="fab fa-instagram" aria-hidden="true"></i></a>
    </div>
  </div>
</div>

<!-- ELECTRIC BAND -->
<div class="electric-band" id="energyBand" aria-hidden="true">
  <div class="container" aria-hidden="true">
    <svg class="lightning-svg" viewBox="0 0 2000 40" preserveAspectRatio="none" aria-hidden="true">
      <path class="zap" d="M10,22 C260,6 520,36 840,20 C1120,8 1440,34 1760,18 C1880,6 1960,28 1990,22" stroke-opacity="0.14"/>
      <path class="zap" d="M10,24 C280,36 600,6 860,22 C1140,36 1460,6 1800,22 C1880,36 1960,10 1990,22" stroke-opacity="0.10"/>
      <path class="bright" id="zapBright" d="M20,22 C300,6 600,34 880,16 C1240,0 1520,32 1860,14 C1960,2 1980,30 1990,22" stroke-opacity="1" stroke-dasharray="520" stroke-dashoffset="520"/>
    </svg>

    <div class="orbs" id="energyOrbs">
      <div class="orb" id="eOrbA"></div>
      <div class="orb" id="eOrbB"></div>
      <div class="orb" id="eOrbC"></div>
    </div>

    <div class="glowline" id="eGlowline"></div>
  </div>
</div>

<!-- Page content (kept largely as you provided) -->
<div class="page-center" role="main">

  <!-- MAP card -->
  <div class="card" id="mapCard">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px">
      <div style="font-weight:800;color:#072012">Carte & zone</div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:13px;color:#072012;margin-right:6px">Pays / Zone :</label>
        <select id="zoneSelect" style="padding:6px;border-radius:6px;border:1px solid #e6e6e6">
          <option value="ci">C√¥te d'Ivoire</option>
          <option value="sn">S√©n√©gal</option>
        </select>

        <label style="font-size:13px;color:#072012;margin-left:8px;margin-right:6px">Ville / Zone :</label>
        <select id="citySelect" style="padding:6px;border-radius:6px;border:1px solid #e6e6e6"></select>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <div class="card">
    <h1>Dimensionnement pompe & solaire ‚Äî Exploitation agricole</h1>
    <div class="muted">Pays ‚Üí Culture ‚Üí Surface ; le champ "Besoin eau (mm/j)" est pr√©-rempli selon le pays.</div>
  </div>

  <!-- INPUTS (identique √† la version pr√©c√©dente) -->
  <div class="card" aria-label="Entr√©es">
    <div class="grid">
      <!-- (all fields remain unchanged) -->
      <div class="field">
        <label>Pays</label>
        <select id="country">
          <option value="ci">C√¥te d'Ivoire</option>
          <option value="sn">S√©n√©gal</option>
        </select>
      </div>

      <div class="field">
        <label>Type de culture</label>
        <select id="crop">
          <option value="tomate">Tomate</option>
          <option value="mais">Ma√Øs</option>
          <option value="riz">Riz</option>
          <option value="mangue">Manguier</option>
          <option value="legume">L√©gume feuille</option>
          <option value="palmier">Palmier</option>
          <option value="custom">Personnalis√© (mm/j)</option>
        </select>
      </div>

      <div class="field">
        <label>Surface (ha)</label>
        <input id="areaHa" type="number" min="0" step="0.01" value="0.5">
      </div>

      <div class="field">
        <label>Besoin eau (mm/j) ‚Äî valeur par d√©faut (selon pays)</label>
        <input id="needMmPerDay" type="number" step="0.1" value="5.0" aria-describedby="needHelp">
        <div id="needHelp" class="muted">La valeur change automatiquement selon le pays + culture s√©lectionn√©s.</div>
      </div>

      <div class="field">
        <label>Irrigation : jours / semaine</label>
        <input id="irrigDays" type="number" min="1" max="7" value="3">
      </div>

      <div class="field">
        <label>Heures de pompage (par jour sur jour d'irrigation)</label>
        <input id="pumpHours" type="number" min="0.1" step="0.1" value="4">
      </div>

      <div class="field">
        <label>Hauteur manom√©trique utile (m)</label>
        <input id="head" type="number" min="0" step="0.1" value="15">
      </div>

      <div class="field">
        <label>Rendement pompe (%)</label>
        <input id="pumpEff" type="number" min="10" max="90" value="55">
      </div>

      <div class="field">
        <label>Heures soleil utiles / jour</label>
        <input id="sunHours" type="number" min="1" step="0.1" value="5">
      </div>

      <div class="field">
        <label>Facteur d√©rating PV (%)</label>
        <input id="pvDerate" type="number" min="10" max="100" value="85">
      </div>

      <div class="field">
        <label>Puissance panneau utilis√© (W)</label>
        <input id="panelW" type="number" min="50" value="350">
      </div>

      <div class="field">
        <label>Pack batterie ‚Äî capacit√© utile pack (kWh)</label>
        <input id="packKwh" type="number" min="0.1" step="0.01" value="1.28">
      </div>

      <div class="field">
        <label>Autonomie secours souhait√©e (jours)</label>
        <input id="autonomyDays" type="number" min="0" step="0.5" value="2">
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="calcBtn" class="btn"><i class="fas fa-calculator" style="margin-right:8px"></i>Calculer</button>
      <button id="exportPdfBtn" class="pdf-btn" title="Exporter la synth√®se en PDF"><i class="fas fa-file-pdf" style="margin-right:8px"></i>Exporter (PDF)</button>
      <button id="resetBtn" class="btn-ghost">R√©initialiser</button>
      <div style="margin-left:auto" class="note">Hypoth√®ses visibles ‚Äî modifie les valeurs (hauteur, rendement) pour affiner.</div>
    </div>
  </div>

  <!-- SUGGESTED AGRI CONSUMERS -->
  <div class="card" aria-label="Consommateurs agricoles propos√©s">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Consommateurs agricoles courants</div>
      <div class="muted">Clique pour ajouter (valeurs indicatives), ou ajoute manuellement.</div>
    </div>

    <div class="suggests" id="suggestList" style="margin-top:10px"></div>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <div style="flex:1">
        <input id="consName" type="text" placeholder="Nom consommateur (ex: Atelier)" style="width:60%;padding:8px;border-radius:6px;border:1px solid #e6e6e6">
        <input id="consPower" type="number" placeholder="Puissance W" style="width:18%;padding:8px;border-radius:6px;border:1px solid #e6e6e6;margin-left:6px">
        <input id="consHours" type="number" placeholder="h/j" style="width:18%;padding:8px;border-radius:6px;border:1px solid #e6e6e6;margin-left:6px">
      </div>
      <button id="addManual" class="btn-ghost">Ajouter manuellement</button>
    </div>

    <div class="consumer-list" id="consumerList"></div>
  </div>

  <!-- RESULTS -->
  <div class="card" aria-label="R√©sultats d√©taill√©s">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">R√©sultats & dimensionnement</div>
      <div class="muted">Valeurs et estimations (incertitude ¬±15%)</div>
    </div>

    <div class="results" id="resultsGrid">
      <!-- (cards left unchanged) -->
      <div class="result-card" id="r_vol">
        <div class="label">Volume eau (m¬≥ / jour)</div>
        <div id="volDay" class="value">0 m¬≥</div>
        <div class="small">Bas√© sur surface √ó mm/j</div>
      </div>

      <div class="result-card" id="r_flow">
        <div class="label">D√©bit pompe requis (m¬≥/h)</div>
        <div id="flowQ" class="value">0 m¬≥/h</div>
        <div class="small">Volume hebdomadaire r√©parti sur jours d'irrigation</div>
      </div>

      <div class="result-card" id="r_pumpkw">
        <div class="label">Puissance pompe (kW)</div>
        <div id="pumpKw" class="value">0 kW</div>
        <div class="small">Puissance √©lectrique d'entr√©e (rendement inclus)</div>
      </div>

      <div class="result-card" id="r_pumpkwh">
        <div class="label">√ânergie pompe (kWh / jour)</div>
        <div id="pumpKwh" class="value">0 kWh/j</div>
        <div class="small">Moyenne journali√®re sur la semaine</div>
      </div>

      <div class="result-card" id="r_others">
        <div class="label">Autres consommateurs (kWh / jour)</div>
        <div id="othersKwh" class="value">0 kWh/j</div>
        <div class="small">Somme des √©quipements ajout√©s</div>
      </div>

      <div class="result-card" id="r_totalkwh">
        <div class="label">Consommation totale (kWh / jour)</div>
        <div id="totalKwhDay" class="value">0 kWh/j</div>
        <div class="small">Pompe + autres, avant pertes invers.</div>
      </div>

      <div class="result-card" id="r_pvkw">
        <div class="label">PV requis (kWc)</div>
        <div id="pvKw" class="value">0 kWc</div>
        <div class="small">Dimensionnement brut (avant redondances)</div>
      </div>

      <div class="result-card" id="r_panels">
        <div class="label">Nb panneaux (~W)</div>
        <div id="panelsCount" class="value">0</div>
        <div class="small">Arrondi au panneau entier</div>
      </div>

      <div class="result-card" id="r_res">
        <div class="label">R√©servoir recommand√© (m¬≥)</div>
        <div id="reservoir" class="value">0 m¬≥</div>
        <div class="small">Pour <span id="autDaysLabel">2</span> jours d'autonomie</div>
      </div>

      <div class="result-card" id="r_batt">
        <div class="label">Batterie estim√©e (kWh utile)</div>
        <div id="batteryKwh" class="value">0 kWh</div>
        <div class="small">Capacit√© utile requise pour l'autonomie</div>
      </div>
    </div>

    <div class="note">Conseil : privil√©gie PV-direct + r√©servoir ; batteries pour nuit / nuages.</div>
  </div>

  <!-- SUMMARY -->
  <div class="summary">
    <div class="big" id="summaryLeft">
      <h2>Synth√®se principale</h2>

      <div class="kpi" style="margin-top:12px">
        <div style="flex:1">
          <div class="muted">Consommation (kWh / mois)</div>
          <div id="consMonth" class="num">0 kWh</div>
          <div id="consMonthRange" class="muted">plage: 0 - 0 kWh</div>
        </div>

        <div style="flex:1">
          <div class="muted">Montant (mensuel)</div>
          <div id="montantMens" class="num">0 FCFA</div>
          <div id="montantMensRange" class="muted">plage: 0 - 0 FCFA</div>
        </div>

        <div style="flex:1">
          <div class="muted">PV requis (kWc)</div>
          <div id="pvReqKwc" class="num">0 kWc</div>
          <div id="pvReqRange" class="muted">incertitude ¬±15%</div>
        </div>
      </div>

      <div style="margin-top:12px" class="note">
        <strong>Remarque :</strong> valeurs indicatives ‚Äî v√©rification terrain recommand√©e.
      </div>
    </div>

    <div class="big" id="summaryRight" style="max-width:420px">
      <h2>D√©tails importants</h2>

      <div style="margin-top:10px">
        <div style="font-weight:800">Pompe</div>
        <div id="summaryPump" class="muted">‚Äî</div>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:800">R√©servoir & autonomie</div>
        <div id="summaryReservoir" class="muted">‚Äî</div>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:800">Packs batterie</div>
        <div id="summaryBatteries" class="muted">‚Äî</div>
      </div>

      <div style="margin-top:12px" class="note">
        Export PDF : filigrane discret ¬´ GREENBRIDGE ‚Äî √Ä TITRE INDICATIF ¬ª en arri√®re-plan.
      </div>
    </div>
  </div>

  <div style="height:32px"></div>
</div> <!-- page-center -->

<!-- Footer: matching other pages (gold line + dark bg + company block) -->
<footer>
  <div class="footer-company" aria-hidden="false">GREENBRIDGE</div>
  <div class="footer-contact" aria-label="Coordonn√©es">
    <div>¬© 2025 GreenBridge. Tous droits r√©serv√©s.</div>
    <div>Abidjan, C√¥te d‚ÄôIvoire</div>
    <div>Tel: +225 07 07 07 07 07</div>
  </div>
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ===========================
   Common UI behavior (nav / mobile / electric-band)
   =========================== */
(function(){
  // Desktop dropdown hover + small-screen toggle
  document.querySelectorAll('.dropdown').forEach(drop => {
    let timer;
    const menu = drop.querySelector('.dropdown-content');
    const trigger = drop.querySelector('a');

    function open(){ if(menu) menu.style.display = 'block'; drop.setAttribute('aria-expanded','true'); }
    function close(){ if(menu) menu.style.display = 'none'; drop.setAttribute('aria-expanded','false'); }

    drop.addEventListener('mouseenter', () => { clearTimeout(timer); if(window.innerWidth > 1100) open(); });
    drop.addEventListener('mouseleave', () => { timer = setTimeout(()=> close(), 220); });

    // on small screens, clicking parent toggles submenu (mobile-friendly)
    trigger.addEventListener('click', function(e){
      if(window.innerWidth <= 1100){
        e.preventDefault();
        if(menu && menu.style.display === 'block'){ close(); } else { open(); }
        // also open mobile nav for better UX
        const mobileNav = document.getElementById('mobileNav');
        const burger = document.getElementById('burgerBtn');
        if(mobileNav && burger){ mobileNav.classList.add('open'); burger.classList.add('open'); mobileNav.setAttribute('aria-hidden','false'); burger.setAttribute('aria-expanded','true'); document.body.style.overflow='hidden'; }
      } // else allow normal navigation on desktop
    });
  });

  // Electric band visuals (orbs + sparks + bright)
  (function(){
    const band = document.getElementById('energyBand');
    if(!band) return;
    const orbA = document.getElementById('eOrbA');
    const orbB = document.getElementById('eOrbB');
    const orbC = document.getElementById('eOrbC');
    const orbs = [orbA, orbB, orbC];
    const bright = document.getElementById('zapBright');

    const params = [
      {rxRatio:0.50, ry:8, speed:0.06, phase:0},
      {rxRatio:0.33, ry:6, speed:0.08, phase:Math.PI/2},
      {rxRatio:0.42, ry:10, speed:0.05, phase:Math.PI}
    ];

    orbs.forEach((o,i)=>{ if(o){ o.classList.add('buzz'); o.style.animationDelay = (i*140)+'ms'; o.style.opacity='1'; } });

    let t0 = performance.now();
    function tick(now){
      const time = (now - t0)/1000;
      const cont = band.querySelector('.container');
      if(!cont){ requestAnimationFrame(tick); return; }
      const rect = cont.getBoundingClientRect();
      const cx = rect.width/2;
      const cy = rect.height/2;
      for(let i=0;i<orbs.length;i++){
        const o = orbs[i]; if(!o) continue;
        const p = params[i];
        const rx = Math.max(Math.min(rect.width * p.rxRatio, 4000), 120);
        const ry = p.ry;
        const angle = (time * p.speed * Math.PI * 2) + p.phase;
        const x = cx + Math.cos(angle) * rx;
        const y = cy + Math.sin(angle) * ry;
        o.style.left = x + 'px';
        o.style.top = y + 'px';
        o.style.transform = 'translate(-50%,-50%)';
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    function sparkBright(){
      if(!bright) return;
      bright.style.transition = 'none';
      try{
        const len = bright.getTotalLength ? bright.getTotalLength() : 520;
        bright.setAttribute('stroke-dasharray', String(len));
        bright.setAttribute('stroke-dashoffset', String(len));
        setTimeout(()=> {
          bright.style.transition = 'stroke-dashoffset 420ms ease-out, opacity 160ms';
          bright.setAttribute('stroke-dashoffset','0');
          setTimeout(()=> { bright.setAttribute('stroke-dashoffset', String(len)); }, 420);
        }, 80);
      }catch(e){
        bright.setAttribute('stroke-dasharray','520');
        bright.setAttribute('stroke-dashoffset','520');
        setTimeout(()=> { bright.style.transition = 'stroke-dashoffset 420ms ease-out'; bright.setAttribute('stroke-dashoffset','0'); }, 80);
      }
    }

    function spawnSparks(){
      const cont = band.querySelector('.container');
      if(!cont) return;
      for(let i=0;i<8;i++){
        const s = document.createElement('div');
        s.style.position='absolute';
        s.style.left = (3 + Math.random()*94) + '%';
        s.style.top = (20 + Math.random()*50) + '%';
        s.style.width = '2px';
        s.style.height = (8 + Math.random()*18) + 'px';
        s.style.borderRadius = '2px';
        s.style.background = 'linear-gradient(180deg, rgba(255,246,180,1), rgba(255,214,0,0.95))';
        s.style.filter = 'blur(6px)';
        s.style.opacity = '0';
        s.style.transform = 'translateY(6px)';
        s.style.pointerEvents = 'none';
        cont.appendChild(s);
        setTimeout(()=> { s.style.transition = 'all 260ms ease-out'; s.style.opacity='1'; s.style.transform='translateY(-6px)'; }, 20 + i*30);
        setTimeout(()=> { s.style.transition = 'all 520ms ease-in'; s.style.opacity='0'; s.style.transform='translateY(-20px)'; }, 300 + i*40);
        setTimeout(()=> { if(s.parentNode) s.parentNode.removeChild(s); }, 820 + i*40);
      }
    }

    function activate(){
      band.classList.add('active');
      spawnSparks(); sparkBright();
      setInterval(()=> {
        spawnSparks();
        if(Math.random() > 0.45) sparkBright();
      }, 1200 + Math.random()*1200);
    }

    const title = document.querySelector('.company-name');
    if(title){ title.addEventListener('click', ()=> { const on = band.classList.toggle('active'); if(on){ spawnSparks(); sparkBright(); } }); }

    activate();
    window.addEventListener('resize', ()=>{ t0 = performance.now(); });
  })();

  /* MOBILE menu behavior + disable active submenu item in mobile nav */
  (function(){
    const burger = document.getElementById('burgerBtn');
    const mobileNav = document.getElementById('mobileNav');
    if(!burger || !mobileNav) return;

    burger.addEventListener('click', ()=> {
      const opened = mobileNav.classList.toggle('open');
      burger.classList.toggle('open', opened);
      burger.setAttribute('aria-expanded', String(opened));
      mobileNav.setAttribute('aria-hidden', String(!opened));
      document.body.style.overflow = opened ? 'hidden' : '';
      const sub = document.getElementById('mobileEnergieSub');
      const toggle = document.getElementById('mobileEnergieToggle');
      if(opened && toggle && toggle.classList.contains('active')) {
        sub.style.display = 'flex';
        toggle.setAttribute('aria-expanded','true');
      }
    });

    // Disable only the actual active page link INSIDE THE MOBILE NAV (so users don't navigate to same page)
    function disableActiveLinksInMobile(){
      if(!mobileNav) return;
      const anchors = mobileNav.querySelectorAll('a');
      anchors.forEach(a=>{
        if(a.id === 'mobileEnergieToggle') return;
        let href = a.getAttribute('href') || a.getAttribute('data-href') || a.dataset.href || '';
        const filename = href ? href.replace(/^.*[\\/]/,'') : '';
        // target this page's filename
        if(filename.toLowerCase() === 'zone_agricole.html'){
          a.classList.add('mobile-disabled');
          a.setAttribute('aria-disabled','true');
          a.setAttribute('tabindex','-1');
          if(a.hasAttribute('href')){ a.dataset.href = a.getAttribute('href'); a.removeAttribute('href'); }
        }
      });
    }
    disableActiveLinksInMobile();

    mobileNav.addEventListener('click', function(e){
      const a = e.target.closest('a');
      if(!a) return;
      if (a.querySelector('.caret')) return;
      if(a.classList.contains('mobile-disabled')){ e.preventDefault(); e.stopPropagation(); return; }
      mobileNav.classList.remove('open');
      burger.classList.remove('open');
      mobileNav.setAttribute('aria-hidden','true');
      burger.setAttribute('aria-expanded','false');
      document.body.style.overflow = '';
    });

    const energieToggle = document.getElementById('mobileEnergieToggle');
    const energieSub = document.getElementById('mobileEnergieSub');
    if(energieToggle && energieSub){
      energieToggle.addEventListener('click', function(e){
        if(e.target.closest('.caret')){
          e.preventDefault(); e.stopPropagation();
          const opening = energieSub.style.display !== 'flex';
          document.querySelectorAll('.mobile-nav .submenu').forEach(s=>{ if(s!==energieSub) s.style.display='none'; });
          energieSub.style.display = opening ? 'flex' : 'none';
          energieToggle.setAttribute('aria-expanded', String(opening));
          energieToggle.classList.toggle('active', opening);
          mobileNav.classList.add('open');
          burger.classList.add('open');
          mobileNav.setAttribute('aria-hidden','false');
          burger.setAttribute('aria-expanded','true');
        } else {
          mobileNav.classList.remove('open');
          burger.classList.remove('open');
          mobileNav.setAttribute('aria-hidden','true');
          burger.setAttribute('aria-expanded','false');
          document.body.style.overflow = '';
        }
      });
    }

    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape' && mobileNav.classList.contains('open')){
        mobileNav.classList.remove('open');
        burger.classList.remove('open');
        mobileNav.setAttribute('aria-hidden','true');
        burger.setAttribute('aria-expanded','false');
        document.body.style.overflow = '';
      }
    });

    function openActiveSubmenuOnSmall(){
      if(window.innerWidth <= 1100){
        const activeToggle = document.getElementById('mobileEnergieToggle');
        const activeSub = document.getElementById('mobileEnergieSub');
        if(activeToggle && activeSub){
          activeSub.style.display = 'flex';
          activeToggle.setAttribute('aria-expanded','true');
          activeToggle.classList.add('active');
        }
      } else {
        const activeSub = document.getElementById('mobileEnergieSub');
        if(activeSub) activeSub.style.display = 'none';
      }
    }
    window.addEventListener('resize', openActiveSubmenuOnSmall);
    openActiveSubmenuOnSmall();

  })();

  /* Auto-detect active nav link and update parent badge (keeps desktop dropdown closed until hovered) */
  (function(){
    const raw = window.location.pathname.split('/').pop().toLowerCase();
    const path = raw || 'zone_agricole.html';
    const mapping = {
      'code1.html':'a[href="Code1.html"]',
      'energie.html':'a[href="energie.html"]',
      'panneaux.html':'a[href="panneaux.html"]',
      'batteries.html':'a[href="batteries.html"]',
      'onduleurs.html':'a[href="onduleurs.html"]',
      'groupes.html':'a[href="groupes.html"]',
      'zone_urbaine.html':'a[href="zone_urbaine.html"]',
      'zone_agricole.html':'a[href="zone_agricole.html"]',
      'domotique.html':'a[href="domotique.html"]',
      'securite.html':'a[href="securite.html"]',
      'maintenance.html':'a[href="maintenance.html"]'
    };

    const sel = mapping[path];
    if(!sel) return;
    const el = document.querySelector(sel);
    if(!el) return;

    el.classList.add('active');
    const inDropdown = el.closest('.dropdown-content');
    if(inDropdown){
      const dropdown = document.querySelector('.dropdown');
      const energieLink = dropdown && dropdown.querySelector('a[href="energie.html"], a[data-current]');
      if(energieLink){
        energieLink.classList.add('active');
        const subBadge = energieLink.querySelector('.sub-badge');
        if(subBadge){
          const label = el.textContent ? el.textContent.trim() : subBadge.textContent.trim();
          subBadge.textContent = label;
          subBadge.style.background = 'rgba(255,214,0,0.08)';
          subBadge.style.boxShadow = '0 6px 18px rgba(0,0,0,0.32)';
        }
      }
      el.classList.add('active-item');
    }

    // mobile mirror
    document.querySelectorAll('.mobile-nav a').forEach(a=>{
      try{
        if(a.getAttribute('href') === el.getAttribute('href')){
          a.classList.add('active');
          const parentSub = a.closest('.submenu');
          if(parentSub){
            parentSub.style.display = 'flex';
            const toggle = document.getElementById('mobileEnergieToggle');
            if(toggle){ toggle.classList.add('active'); toggle.setAttribute('aria-expanded','true'); }
          }
        }
      }catch(e){}
    });

  })();

})(); /* end common UI IIFE */

/* ===========================
   Helpers & initial data (kept from your original)
   =========================== */
function fmt(n,dec=2){ return Number(n||0).toFixed(dec).replace(/\B(?=(\d{3})+(?!\d))/g,' '); }
function fcfa(n){ return Number(Math.round(n||0)).toLocaleString('fr-FR') + ' FCFA' }

const CITY_COORDS = {
  'ci_all': { bounds: [[5.345317,-4.024429],[6.818351,-5.276987]] , center:[6.05,-4.65], zoom:7 },
  'ci_abidjan': {lat:5.345317, lng:-4.024429, zoom:12 },
  'ci_yamoussoukro': {lat:6.818351, lng:-5.276987, zoom:11 },
  'sn_all': { center:[14.0,-14.0], zoom:6 },
  'sn_dakar': {lat:14.6937, lng:-17.44406, zoom:12 }
};

const CROP_DEFAULTS_BY_COUNTRY = {
  'ci': { 'tomate':5.0,'mais':4.5,'riz':6.5,'mangue':3.5,'legume':5.5,'palmier':4.0 },
  'sn': { 'tomate':6.0,'mais':5.0,'riz':7.5,'mangue':3.8,'legume':6.0,'palmier':4.5 }
};
const CROP_GENERIC_DEFAULT = 5.0;

const SUGGESTED = [
  { id:'lighting', label:'√âclairage LED (hangar/serre)', power:100, hours:6 },
  { id:'fridge', label:'R√©frig√©rateur / chambre froide', power:200, hours:8 },
  { id:'charger', label:'Recharge t√©l√©phones (borne)', power:200, hours:6 },
  { id:'radio', label:'Radio / Sono / Info', power:80, hours:6 },
  { id:'local_staff', label:'Local employ√©s (√©clairage + prises)', power:300, hours:8 },
  { id:'aerator', label:'A√©rateur bassin pisciculture', power:250, hours:6 },
  { id:'sprayer', label:'Pulv√©risateur √©lectrique', power:300, hours:1 },
  { id:'moulin', label:'Broyeur/moulin', power:1500, hours:1 },
  { id:'pump_secondary', label:'Pompe annexe', power:1500, hours:0.5 }
];

/* state */
let consumers = [];
let lastCalcSnapshot = null;

/* DOM refs */
const zoneSelect = document.getElementById('zoneSelect');
const citySelect = document.getElementById('citySelect');

const countryEl = document.getElementById('country');
const cropEl = document.getElementById('crop');
const areaHaEl = document.getElementById('areaHa');
const needMmEl = document.getElementById('needMmPerDay');
const irrigDaysEl = document.getElementById('irrigDays');
const pumpHoursEl = document.getElementById('pumpHours');
const headEl = document.getElementById('head');
const pumpEffEl = document.getElementById('pumpEff');
const sunHoursEl = document.getElementById('sunHours');
const pvDerateEl = document.getElementById('pvDerate');
const panelWEl = document.getElementById('panelW');
const packKwhEl = document.getElementById('packKwh');
const autonomyDaysEl = document.getElementById('autonomyDays');

const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const exportPdfBtn = document.getElementById('exportPdfBtn');

const suggestListEl = document.getElementById('suggestList');
const consListEl = document.getElementById('consumerList');
const addManualBtn = document.getElementById('addManual');
const consNameInput = document.getElementById('consName');
const consPowerInput = document.getElementById('consPower');
const consHoursInput = document.getElementById('consHours');

const volDayEl = document.getElementById('volDay');
const flowQEl = document.getElementById('flowQ');
const pumpKwEl = document.getElementById('pumpKw');
const pumpKwhEl = document.getElementById('pumpKwh');
const othersKwhEl = document.getElementById('othersKwh');
const totalKwhDayEl = document.getElementById('totalKwhDay');
const pvKwEl = document.getElementById('pvKw');
const panelsCountEl = document.getElementById('panelsCount');
const reservoirEl = document.getElementById('reservoir');
const batteryKwhEl = document.getElementById('batteryKwh');

const consMonthEl = document.getElementById('consMonth');
const consMonthRangeEl = document.getElementById('consMonthRange');
const montantMensEl = document.getElementById('montantMens');
const montantMensRangeEl = document.getElementById('montantMensRange');
const pvReqKwcEl = document.getElementById('pvReqKwc');
const pvReqRangeEl = document.getElementById('pvReqRange');

const summaryPumpEl = document.getElementById('summaryPump');
const summaryReservoirEl = document.getElementById('summaryReservoir');
const summaryBatteriesEl = document.getElementById('summaryBatteries');
const autDaysLabel = document.getElementById('autDaysLabel');

/* ===========================
   Map functions
   =========================== */
let map = null;
function initMap(){
  try {
    map = L.map('map', { dragging:true, zoomControl:true, attributionControl:false }).setView([6.5, -5.0], 6.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
    const pin = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[22,22], iconAnchor:[11,22] });

    L.marker([5.345317,-4.024429],{icon:pin}).addTo(map).bindTooltip('Abidjan');
    L.marker([6.818351,-5.276987],{icon:pin}).addTo(map).bindTooltip('Yamoussoukro');
    L.marker([14.6937,-17.44406],{icon:pin}).addTo(map).bindTooltip('Dakar');

    map.fitBounds([[5.345317,-4.024429],[6.818351,-5.276987]], { padding:[20,20] });
  } catch(e){ console.warn('Leaflet init failed', e) }
}

function populateCities(zone){
  citySelect.innerHTML = '';
  if(zone === 'ci'){
    citySelect.appendChild(new Option("C√¥te d'Ivoire (toutes zones)", 'ci_all'));
    citySelect.appendChild(new Option("Abidjan", 'ci_abidjan'));
    citySelect.appendChild(new Option("Yamoussoukro", 'ci_yamoussoukro'));
    citySelect.value = 'ci_abidjan';
  } else {
    citySelect.appendChild(new Option("S√©n√©gal (toutes zones)", 'sn_all'));
    citySelect.appendChild(new Option("Dakar", 'sn_dakar'));
    citySelect.value = 'sn_dakar';
  }
  zoomToCity(citySelect.value);
}

function zoomToCity(key){
  if(!map) return;
  const info = CITY_COORDS[key];
  if(!info) return;
  if(info.bounds){ map.fitBounds(info.bounds, {padding:[20,20]}); }
  else if(info.lat && info.lng){ map.setView([info.lat, info.lng], info.zoom || 10); }
  else if(info.center){ map.setView(info.center, info.zoom || 7); }
}

/* ===========================
   Consumers management
   =========================== */
function renderSuggested(){
  suggestListEl.innerHTML = '';
  SUGGESTED.forEach(s=>{
    const btn = document.createElement('button');
    btn.className = 'suggest';
    btn.innerText = s.label + ' ‚Äî ' + s.power + 'W';
    btn.addEventListener('click', ()=> {
      consumers.push({name:s.label, power:s.power, hours:s.hours});
      renderConsumers();
      computeAll();
    });
    suggestListEl.appendChild(btn);
  });
}
renderSuggested();

function renderConsumers(){
  consListEl.innerHTML = '';
  if(consumers.length === 0){
    consListEl.innerHTML = '<div class="muted" style="color:#6b7f6b;padding:8px">Aucun consommateur additionnel</div>';
    return;
  }
  consumers.forEach((c, idx) => {
    const div = document.createElement('div');
    div.className = 'consumer';
    div.innerHTML = `<div><strong>${c.name}</strong><div class="meta">${c.power} W √ó ${c.hours} h/j</div></div>
      <div style="display:flex;gap:8px">
        <button data-idx="${idx}" class="btn-ghost edit">√âditer</button>
        <button data-idx="${idx}" class="btn-ghost del">Suppr</button>
      </div>`;
    consListEl.appendChild(div);
  });
  consListEl.querySelectorAll('.del').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const i = +ev.target.dataset.idx;
      consumers.splice(i,1);
      renderConsumers();
      computeAll();
    });
  });
  consListEl.querySelectorAll('.edit').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const i = +ev.target.dataset.idx;
      const c = consumers[i];
      const name = prompt('Nom', c.name);
      if(name === null) return;
      const power = parseFloat(prompt('Puissance (W)', c.power));
      if(isNaN(power)) return alert('Puissance invalide');
      const hours = parseFloat(prompt('Heures/j', c.hours));
      if(isNaN(hours)) return alert('Heures invalides');
      consumers[i] = { name, power, hours };
      renderConsumers();
      computeAll();
    });
  });
}

addManualBtn.addEventListener('click', ()=>{
  const name = (consNameInput.value||'').trim();
  const power = Number(consPowerInput.value||0);
  const hours = Number(consHoursInput.value||0);
  if(!name || power <= 0 || hours <= 0){ alert('Nom, puissance et heures/j obligatoires'); return; }
  consumers.push({name,power,hours});
  consNameInput.value=''; consPowerInput.value=''; consHoursInput.value='';
  renderConsumers();
  computeAll();
});

/* ===========================
   Country + crop wiring
   =========================== */
function updateNeedMmForCountryAndCrop(){
  const country = (countryEl.value || 'ci');
  const crop = (cropEl.value || 'tomate');
  if(crop === 'custom') return;
  const countryDefaults = CROP_DEFAULTS_BY_COUNTRY[country] || {};
  const val = (typeof countryDefaults[crop] === 'number') ? countryDefaults[crop] : CROP_GENERIC_DEFAULT;
  needMmEl.value = val;
}
function syncCountryToZone(){
  const c = countryEl.value;
  if(c === 'ci') zoneSelect.value = 'ci';
  else if(c === 'sn') zoneSelect.value = 'sn';
  populateCities(zoneSelect.value);
}
function syncZoneToCountry(){
  const z = zoneSelect.value;
  if(z === 'ci') countryEl.value = 'ci';
  else if(z === 'sn') countryEl.value = 'sn';
  updateNeedMmForCountryAndCrop();
}

/* ===========================
   Core calculations
   =========================== */
function computeAll(){
  const areaHa = Math.max(0, Number(areaHaEl.value||0));
  const areaM2 = areaHa * 10000;
  const mmPerDay = Math.max(0, Number(needMmEl.value||0));
  const irrigDays = Math.max(1, Number(irrigDaysEl.value||1));
  const pumpHours = Math.max(0.1, Number(pumpHoursEl.value||1));
  const head = Math.max(0, Number(headEl.value||0));
  const pumpEff = Math.max(0.01, Number(pumpEffEl.value||55))/100;
  const sunH = Math.max(0.1, Number(sunHoursEl.value||5));
  const pvDerate = Math.max(0.01, Number(pvDerateEl.value||85))/100;
  const panelW = Math.max(10, Number(panelWEl.value||350));
  const packKwh = Math.max(0.01, Number(packKwhEl.value||1.28));
  const autonomyDays = Math.max(0, Number(autonomyDaysEl.value||2));

  const volDay_m3 = (areaM2 * mmPerDay) / 1000;
  const weeklyVol = volDay_m3 * 7;
  const volPerPumpingDay = weeklyVol / irrigDays;
  const q_m3h = (pumpHours > 0) ? (volPerPumpingDay / pumpHours) : 0;

  const phyd_W = 2.725 * q_m3h * head;
  const pInput_W = pumpEff > 0 ? phyd_W / pumpEff : 0;
  const pInput_kW = pInput_W / 1000;

  const energyPumpPerPumpingDay_kWh = (pInput_kW * pumpHours);
  const energyPumpDailyAvg_kWh = (energyPumpPerPumpingDay_kWh * irrigDays) / 7;

  let others_kwh = 0;
  consumers.forEach(c => { others_kwh += (Number(c.power||0) * Number(c.hours||0)) / 1000; });

  const systemEff = 0.95;
  const totalDaily_kWh = (energyPumpDailyAvg_kWh + others_kwh) / systemEff;

  const pvKw = (sunH * pvDerate) > 0 ? (totalDaily_kWh / (sunH * pvDerate)) : 0;
  const panels = Math.max(0, Math.ceil((pvKw * 1000) / panelW));

  const reservoir_m3 = autonomyDays * volDay_m3;

  let nightShare = 0.35;
  const totalHoursOtherWeighted = consumers.reduce((s,c)=> s + (Number(c.hours||0)),0);
  if(totalHoursOtherWeighted > 10) nightShare = Math.min(0.6, 0.35 + (totalHoursOtherWeighted - 10) * 0.01);
  const dailyNightKwh = totalDaily_kWh * nightShare;
  const DoD = 0.9;
  const batteryNeeded_kWh = autonomyDays > 0 ? (dailyNightKwh * autonomyDays) / DoD : 0;
  const packsRequired = batteryNeeded_kWh > 0 ? Math.ceil(batteryNeeded_kWh / packKwh) : 0;

  const totalMonthly_kWh = totalDaily_kWh * 30;
  const price_kwh = 95;
  const energy_ht = totalMonthly_kWh * price_kwh;
  const tva = energy_ht * 0.18;
  const montantMensuel = energy_ht + tva;

  const lowFactor = 0.85, highFactor = 1.15;
  const lowMonthly = totalMonthly_kWh * lowFactor;
  const highMonthly = totalMonthly_kWh * highFactor;
  const lowMontant = (lowMonthly * price_kwh) * 1.18;
  const highMontant = (highMonthly * price_kwh) * 1.18;

  volDayEl.innerText = fmt(volDay_m3,3) + ' m¬≥';
  flowQEl.innerText = fmt(q_m3h,3) + ' m¬≥/h';
  pumpKwEl.innerText = fmt(pInput_kW,3) + ' kW';
  pumpKwhEl.innerText = fmt(energyPumpDailyAvg_kWh,3) + ' kWh/j';
  othersKwhEl.innerText = fmt(others_kwh,3) + ' kWh/j';
  totalKwhDayEl.innerText = fmt(totalDaily_kWh,3) + ' kWh/j';
  pvKwEl.innerText = fmt(pvKw,3) + ' kWc';
  panelsCountEl.innerText = panels;
  reservoirEl.innerText = fmt(reservoir_m3,3) + ' m¬≥';
  batteryKwhEl.innerText = fmt(batteryNeeded_kWh,3) + ' kWh (' + packsRequired + ' packs)';

  consMonthEl.innerText = fmt(totalMonthly_kWh,2) + ' kWh';
  consMonthRangeEl.innerText = `plage: ${fmt(lowMonthly,2)} - ${fmt(highMonthly,2)} kWh`;
  montantMensEl.innerText = fcfa(Math.round(montantMensuel));
  montantMensRangeEl.innerText = `plage: ${fcfa(Math.round(lowMontant))} - ${fcfa(Math.round(highMontant))}`;

  pvReqKwcEl.innerText = fmt(pvKw,3) + ' kWc';
  pvReqRangeEl.innerText = `¬±15% ‚Üí ${fmt(pvKw*0.85,2)} - ${fmt(pvKw*1.15,2)} kWc`;

  summaryPumpEl.innerText = `${fmt(pInput_kW,3)} kW - d√©bit ${fmt(q_m3h,3)} m¬≥/h (hauteur ${head} m). Consommation pompe: ${fmt(energyPumpDailyAvg_kWh,3)} kWh/j`;
  summaryReservoirEl.innerText = `${fmt(reservoir_m3,3)} m¬≥ ‚Üí autonomie ${autonomyDays} j (√† ${fmt(volDay_m3,3)} m¬≥/j)`;
  summaryBatteriesEl.innerText = `${Math.round(packsRequired)} packs √ó ${fmt(packKwh,2)} kWh ‚âà ${fmt(batteryNeeded_kWh,2)} kWh utile (DoD ${DoD*100}%)`;

  autDaysLabel.innerText = autonomyDays;

  document.getElementById('r_pumpkw').classList.toggle('highlight', pInput_kW >= 5);
  document.getElementById('r_batt').classList.toggle('highlight', batteryNeeded_kWh > 0);

  lastCalcSnapshot = {
    timestamp: new Date().toLocaleString('fr-FR'),
    country: countryEl.value,
    city: citySelect.value,
    crop: cropEl.value,
    areaHa, mmPerDay,
    volDay_m3, q_m3h, pInput_kW, energyPumpDailyAvg_kWh,
    others_kwh, totalDaily_kWh, pvKw, panels, reservoir_m3, batteryNeeded_kWh, packsRequired,
    totalMonthly_kWh, montantMensuel, lowMonthly, highMonthly, lowMontant, highMontant,
    consumers: JSON.parse(JSON.stringify(consumers))
  };
}

/* ===========================
   PDF generation (kept as in your original)
   =========================== */
async function generatePDF(){
  try {
    if(!lastCalcSnapshot){
      alert("Veuillez effectuer un calcul (Cliquer sur Calculer) avant d'exporter le PDF.");
      return;
    }
    const s = lastCalcSnapshot;

    function esc(t){ return String(t||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    let consumersHtml = '';
    if((s.consumers||[]).length === 0){
      consumersHtml = `<tr><td colspan="4" style="padding:8px;border:1px solid #eee;text-align:center;color:#666">Aucun consommateur ajout√©</td></tr>`;
    } else {
      s.consumers.forEach(c=>{
        const kwhj = ((c.power*c.hours)/1000).toFixed(3);
        consumersHtml += `<tr>
          <td style="padding:8px;border:1px solid #eee">${esc(c.name)}</td>
          <td style="padding:8px;border:1px solid #eee;text-align:center">${esc(c.power)} W</td>
          <td style="padding:8px;border:1px solid #eee;text-align:center">${esc(c.hours)} h/j</td>
          <td style="padding:8px;border:1px solid #eee;text-align:center">${esc(kwhj)} kWh/j</td>
        </tr>`;
      });
    }

    const flagSVG = (s.country === 'sn') ? `
      <svg width="84" height="56" viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
        <rect width="1" height="2" x="0" fill="#00a551"></rect>
        <rect width="1" height="2" x="1" fill="#fcd116"></rect>
        <rect width="1" height="2" x="2" fill="#0066cc"></rect>
        <g transform="translate(1.5,1)">
          <path d="M0 -0.45 L0.11 -0.15 L0.45 -0.15 L0.17 0.03 L0.28 0.33 L0 0.15 L-0.28 0.33 L-0.17 0.03 L-0.45 -0.15 L-0.11 -0.15 Z" fill="#006400" transform="scale(0.6)"/>
        </g>
      </svg>
    ` : `
      <svg width="84" height="56" viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
        <rect width="1" height="2" x="0" fill="#009e60"></rect>
        <rect width="1" height="2" x="1" fill="#ffffff"></rect>
        <rect width="1" height="2" x="2" fill="#f77f00"></rect>
      </svg>
    `;

    const html = `
      <div id="pdfWrapper" style="position:relative;width:820px;padding:20px;background:#fff;color:#222;font-family:Arial,Helvetica,sans-serif;">
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-30deg);z-index:0;pointer-events:none;opacity:0.06;font-size:72px;color:#000;font-weight:900;white-space:nowrap">
          GREENBRIDGE ‚Äî √Ä TITRE INDICATIF
        </div>

        <div style="position:relative;z-index:1;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="display:flex;gap:12px;align-items:center">
              <div style="background:linear-gradient(180deg,#e9f7ed,#d9f0db);padding:8px;border-radius:8px;border:1px solid #dfeedf">
                <div style="font-weight:800;color:#04462e;font-size:16px">GREENBRIDGE</div>
                <div style="font-size:11px;color:#556b56">√ânergie & Domotique</div>
              </div>
              <div>
                <div style="font-size:16px;font-weight:700;color:#062d1b">R√©sultats & dimensionnement</div>
                <div style="font-size:12px;color:#666;margin-top:4px">${esc(s.timestamp)} ‚Äî ${esc(s.crop)} ‚Äî ${esc(s.areaHa)} ha</div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="width:84px;height:56px">${flagSVG}</div>
              <div style="font-size:11px;color:#666;margin-top:6px">${esc(s.country)}</div>
            </div>
          </div>

          <div style="border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:12px;background:#fbfffb">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div>
                <div style="font-weight:700">Volume eau (m¬≥ / jour)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.volDay_m3,3))} m¬≥</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Bas√© sur surface √ó mm/j</div>
              </div>

              <div>
                <div style="font-weight:700">D√©bit pompe requis (m¬≥/h)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.q_m3h,3))} m¬≥/h</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Volume hebdomadaire r√©parti sur jours d'irrigation</div>
              </div>

              <div>
                <div style="font-weight:700">Puissance pompe (kW)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.pInput_kW,3))} kW</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Puissance √©lectrique d'entr√©e (rendement inclus)</div>
              </div>

              <div>
                <div style="font-weight:700">√ânergie pompe (kWh / jour)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.energyPumpDailyAvg_kWh,3))} kWh/j</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Moyenne journali√®re sur la semaine</div>
              </div>

              <div>
                <div style="font-weight:700">Autres consommateurs (kWh / jour)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.others_kwh,3))} kWh/j</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Somme des √©quipements ajout√©s</div>
              </div>

              <div>
                <div style="font-weight:700">Consommation totale (kWh / jour)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.totalDaily_kWh,3))} kWh/j</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Pompe + autres, avant pertes invers.</div>
              </div>

              <div>
                <div style="font-weight:700">PV requis (kWc)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.pvKw,3))} kWc</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Dimensionnement brut (avant redondances)</div>
              </div>

              <div>
                <div style="font-weight:700">Nb panneaux (~W)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(s.panels)}</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Arrondi au panneau entier</div>
              </div>

              <div>
                <div style="font-weight:700">R√©servoir recommand√© (m¬≥)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.reservoir_m3,3))} m¬≥</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Pour ${esc(autonomyDaysEl.value || 2)} jours d'autonomie</div>
              </div>

              <div>
                <div style="font-weight:700">Batterie estim√©e (kWh utile)</div>
                <div style="font-size:18px;font-weight:800;color:#0b4d26;margin-top:6px">${esc(fmt(s.batteryNeeded_kWh,3))} kWh (${esc(s.packsRequired||0)} packs)</div>
                <div style="font-size:12px;color:#666;margin-top:6px">Capacit√© utile requise pour l'autonomie</div>
              </div>
            </div>
          </div>

          <div style="font-weight:700;margin-bottom:8px">D√©tail Consommateurs</div>
          <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:12px">
            <thead>
              <tr>
                <th style="border:1px solid #eee;padding:6px;background:#f7f7f7;text-align:left">√âquipement</th>
                <th style="border:1px solid #eee;padding:6px;background:#f7f7f7;text-align:center">Puissance</th>
                <th style="border:1px solid #eee;padding:6px;background:#f7f7f7;text-align:center">Heures/j</th>
                <th style="border:1px solid #eee;padding:6px;background:#f7f7f7;text-align:center">kWh / j</th>
              </tr>
            </thead>
            <tbody>
              ${consumersHtml}
            </tbody>
          </table>

          <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#666">
            <div>Synth√®se g√©n√©r√©e par GREENBRIDGE ‚Äî √† titre indicatif</div>
            <div>Export : ${esc(s.timestamp)}</div>
          </div>
        </div>
      </div>
    `;

    // render offscreen and convert to PDF (same logic)
    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-5000px';
    wrapper.style.top = '0';
    wrapper.innerHTML = html;
    document.body.appendChild(wrapper);

    const element = wrapper.firstElementChild;
    const scale = 2;
    const canvas = await html2canvas(element, { scale: scale, useCORS:true, backgroundColor: '#ffffff' });
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 10;
    const imgProps = pdf.getImageProperties(imgData);
    const pdfImgWidth = pageWidth - margin*2;
    const pdfImgHeight = (imgProps.height * pdfImgWidth) / imgProps.width;

    if(pdfImgHeight <= pageHeight - margin*2){
      pdf.addImage(imgData,'PNG', margin, margin, pdfImgWidth, pdfImgHeight);
    } else {
      const sliceHeightPx = Math.floor((pageHeight - margin*2) / pdfImgHeight * canvas.height);
      let rendered = 0;
      while(rendered < canvas.height){
        const sliceH = Math.min(canvas.height - rendered, sliceHeightPx);
        const sliceCanvas = document.createElement('canvas');
        sliceCanvas.width = canvas.width;
        sliceCanvas.height = sliceH;
        const ctx = sliceCanvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0,0,sliceCanvas.width,sliceCanvas.height);
        ctx.drawImage(canvas, 0, rendered, sliceCanvas.width, sliceCanvas.height, 0, 0, sliceCanvas.width, sliceCanvas.height);
        const sliceData = sliceCanvas.toDataURL('image/png');
        const sliceImgProps = pdf.getImageProperties(sliceData);
        const sliceImgHeight = (sliceImgProps.height * pdfImgWidth) / sliceImgProps.width;
        if(rendered > 0) pdf.addPage();
        pdf.addImage(sliceData, 'PNG', margin, margin, pdfImgWidth, sliceImgHeight);
        rendered += sliceH;
      }
    }

    pdf.setFontSize(9);
    pdf.setTextColor(120);
    pdf.text('GreenBridge ‚Äî Synth√®se indicative', margin, pageHeight - 6);

    const filename = `GreenBridge_zone_agricole_synthese_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
    pdf.save(filename);

    document.body.removeChild(wrapper);
  } catch(err){
    console.error(err);
    alert('Erreur lors de la g√©n√©ration du PDF. Voir console pour d√©tails.');
  }
}

/* ===========================
   Wiring & init
   =========================== */
cropEl.addEventListener('change', ()=> updateNeedMmForCountryAndCrop());
countryEl.addEventListener('change', ()=> { syncCountryToZone(); updateNeedMmForCountryAndCrop(); });
zoneSelect.addEventListener('change', ()=> { syncZoneToCountry(); });
citySelect.addEventListener('change', ()=> zoomToCity(citySelect.value));

calcBtn.addEventListener('click', computeAll);
resetBtn.addEventListener('click', ()=>{
  if(!confirm('R√©initialiser les champs aux valeurs par d√©faut ?')) return;
  countryEl.value='ci';
  zoneSelect.value='ci';
  populateCities(zoneSelect.value);
  cropEl.value='tomate';
  areaHaEl.value='0.5';
  needMmEl.value='5.0';
  irrigDaysEl.value='3';
  pumpHoursEl.value='4';
  headEl.value='15';
  pumpEffEl.value='55';
  sunHoursEl.value='5';
  pvDerateEl.value='85';
  panelWEl.value='350';
  packKwhEl.value='1.28';
  autonomyDaysEl.value='2';
  consumers = [];
  renderConsumers();
  updateNeedMmForCountryAndCrop();
  computeAll();
});

exportPdfBtn.addEventListener('click', generatePDF);

/* live updates */
[
  areaHaEl, needMmEl, irrigDaysEl, pumpHoursEl, headEl, pumpEffEl,
  sunHoursEl, pvDerateEl, panelWEl, packKwhEl, autonomyDaysEl
].forEach(el => el.addEventListener('input', () => computeAll()));

/* init */
document.addEventListener('DOMContentLoaded', ()=> {
  initMap();
  populateCities(zoneSelect.value);
  renderSuggested();
  renderConsumers();
  if(countryEl.value !== zoneSelect.value) zoneSelect.value = countryEl.value;
  updateNeedMmForCountryAndCrop();
  computeAll();
});
</script>
</body>
</html>
